<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶æ“ä½œåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.danger {
            background: #dc3545;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .result.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .result.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MingLog æ–‡ä»¶æ“ä½œåŠŸèƒ½æµ‹è¯•</h1>
        
        <div id="connection-status" class="status disconnected">
            è¿æ¥çŠ¶æ€: æ£€æŸ¥ä¸­...
        </div>
        
        <div class="test-grid">
            <div class="test-section">
                <h3>Markdown å¯¼å…¥æµ‹è¯•</h3>
                <p>æµ‹è¯•ä»Markdownæ–‡ä»¶å¯¼å…¥é¡µé¢å’Œå—çš„åŠŸèƒ½</p>
                <button onclick="testMarkdownImport()">æµ‹è¯•å¯¼å…¥åŠŸèƒ½</button>
                <div id="import-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>é¡µé¢å¯¼å‡ºæµ‹è¯•</h3>
                <p>æµ‹è¯•å°†é¡µé¢å¯¼å‡ºä¸ºMarkdownæ–‡ä»¶çš„åŠŸèƒ½</p>
                <button onclick="testPageExport()">æµ‹è¯•å¯¼å‡ºåŠŸèƒ½</button>
                <div id="export-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>æ•°æ®å¤‡ä»½æµ‹è¯•</h3>
                <p>æµ‹è¯•åˆ›å»ºå®Œæ•´æ•°æ®å¤‡ä»½çš„åŠŸèƒ½</p>
                <button onclick="testCreateBackup()">æµ‹è¯•å¤‡ä»½åŠŸèƒ½</button>
                <div id="backup-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>æ–‡ä»¶å¯¹è¯æ¡†æµ‹è¯•</h3>
                <p>æµ‹è¯•æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†åŠŸèƒ½</p>
                <button onclick="testFileDialog()">æµ‹è¯•æ–‡ä»¶å¯¹è¯æ¡†</button>
                <div id="dialog-result" class="result"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>å®Œæ•´æ–‡ä»¶æ“ä½œæµ‹è¯•</h3>
            <button class="success" onclick="runFullFileOperationTest()" style="font-size: 16px; padding: 12px 24px;">è¿è¡Œå®Œæ•´æ–‡ä»¶æ“ä½œæµ‹è¯•</button>
            <div id="full-test-result" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { invoke } from '@tauri-apps/api/core';
        
        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                await invoke('get_app_info');
                document.getElementById('connection-status').textContent = 'è¿æ¥çŠ¶æ€: å·²è¿æ¥';
                document.getElementById('connection-status').className = 'status connected';
                return true;
            } catch (error) {
                document.getElementById('connection-status').textContent = 'è¿æ¥çŠ¶æ€: æœªè¿æ¥ - ' + error.toString();
                document.getElementById('connection-status').className = 'status disconnected';
                return false;
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        function showError(elementId, error) {
            showResult(elementId, { error: error.toString() }, true);
        }
        
        function log(message) {
            console.log(`[${new Date().toISOString()}] ${message}`);
        }
        
        // æµ‹è¯•å‡½æ•°
        window.testMarkdownImport = async function() {
            try {
                log('å¼€å§‹æµ‹è¯•Markdownå¯¼å…¥åŠŸèƒ½');
                
                const result = await invoke('import_markdown_files_with_dialog', {
                    graphId: 'default'
                });
                
                showResult('import-result', {
                    message: 'å¯¼å…¥æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });
                
                log(`å¯¼å…¥æµ‹è¯•å®Œæˆ: ${result.pages_imported} é¡µé¢, ${result.blocks_imported} å—`);
            } catch (error) {
                log('å¯¼å…¥æµ‹è¯•å¤±è´¥: ' + error.toString());
                showError('import-result', error);
            }
        };
        
        window.testPageExport = async function() {
            try {
                log('å¼€å§‹æµ‹è¯•é¡µé¢å¯¼å‡ºåŠŸèƒ½');
                
                // é¦–å…ˆè·å–æ‰€æœ‰é¡µé¢
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });
                
                if (pages.length === 0) {
                    showResult('export-result', {
                        message: 'æ²¡æœ‰é¡µé¢å¯å¯¼å‡ºï¼Œè¯·å…ˆåˆ›å»ºä¸€äº›é¡µé¢',
                        timestamp: new Date().toISOString()
                    }, true);
                    return;
                }
                
                const pageIds = pages.map(page => page.id);
                
                const result = await invoke('export_pages_with_dialog', {
                    pageIds: pageIds
                });
                
                showResult('export-result', {
                    message: 'å¯¼å‡ºæµ‹è¯•å®Œæˆ',
                    result: result,
                    pages_count: pages.length,
                    timestamp: new Date().toISOString()
                });
                
                log(`å¯¼å‡ºæµ‹è¯•å®Œæˆ: ${result.files_exported} æ–‡ä»¶, ${result.total_size} å­—èŠ‚`);
            } catch (error) {
                log('å¯¼å‡ºæµ‹è¯•å¤±è´¥: ' + error.toString());
                showError('export-result', error);
            }
        };
        
        window.testCreateBackup = async function() {
            try {
                log('å¼€å§‹æµ‹è¯•å¤‡ä»½åˆ›å»ºåŠŸèƒ½');
                
                const backupPath = await invoke('create_backup_with_dialog');
                
                showResult('backup-result', {
                    message: 'å¤‡ä»½åˆ›å»ºæˆåŠŸ',
                    backup_path: backupPath,
                    timestamp: new Date().toISOString()
                });
                
                log(`å¤‡ä»½åˆ›å»ºæˆåŠŸ: ${backupPath}`);
            } catch (error) {
                log('å¤‡ä»½åˆ›å»ºå¤±è´¥: ' + error.toString());
                showError('backup-result', error);
            }
        };
        
        window.testFileDialog = async function() {
            try {
                log('å¼€å§‹æµ‹è¯•æ–‡ä»¶å¯¹è¯æ¡†åŠŸèƒ½');
                
                // æµ‹è¯•æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†
                const files = await invoke('open_file_dialog', {
                    filters: [['Markdown Files', ['md', 'txt']]],
                    multiple: true
                });
                
                // æµ‹è¯•ä¿å­˜æ–‡ä»¶å¯¹è¯æ¡†
                const saveFile = await invoke('save_file_dialog', {
                    defaultName: 'test.md',
                    filters: [['Markdown Files', ['md']]]
                });
                
                // æµ‹è¯•é€‰æ‹©æ–‡ä»¶å¤¹å¯¹è¯æ¡†
                const folder = await invoke('select_folder_dialog');
                
                showResult('dialog-result', {
                    message: 'æ–‡ä»¶å¯¹è¯æ¡†æµ‹è¯•å®Œæˆ',
                    open_files: files,
                    save_file: saveFile,
                    selected_folder: folder,
                    timestamp: new Date().toISOString()
                });
                
                log('æ–‡ä»¶å¯¹è¯æ¡†æµ‹è¯•å®Œæˆ');
            } catch (error) {
                log('æ–‡ä»¶å¯¹è¯æ¡†æµ‹è¯•å¤±è´¥: ' + error.toString());
                showError('dialog-result', error);
            }
        };
        
        window.runFullFileOperationTest = async function() {
            const startTime = Date.now();
            log('å¼€å§‹è¿è¡Œå®Œæ•´æ–‡ä»¶æ“ä½œæµ‹è¯•å¥—ä»¶');
            
            try {
                let results = [];
                
                // 1. å¯¼å…¥æµ‹è¯•
                results.push('1. æµ‹è¯•Markdownå¯¼å…¥åŠŸèƒ½...');
                await testMarkdownImport();
                results.push('   âœ… å¯¼å…¥åŠŸèƒ½æµ‹è¯•å®Œæˆ');
                
                // ç­‰å¾…ä¸€ä¸‹
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 2. å¯¼å‡ºæµ‹è¯•
                results.push('2. æµ‹è¯•é¡µé¢å¯¼å‡ºåŠŸèƒ½...');
                await testPageExport();
                results.push('   âœ… å¯¼å‡ºåŠŸèƒ½æµ‹è¯•å®Œæˆ');
                
                // ç­‰å¾…ä¸€ä¸‹
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 3. å¤‡ä»½æµ‹è¯•
                results.push('3. æµ‹è¯•å¤‡ä»½åˆ›å»ºåŠŸèƒ½...');
                await testCreateBackup();
                results.push('   âœ… å¤‡ä»½åŠŸèƒ½æµ‹è¯•å®Œæˆ');
                
                // ç­‰å¾…ä¸€ä¸‹
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 4. æ–‡ä»¶å¯¹è¯æ¡†æµ‹è¯•
                results.push('4. æµ‹è¯•æ–‡ä»¶å¯¹è¯æ¡†åŠŸèƒ½...');
                await testFileDialog();
                results.push('   âœ… æ–‡ä»¶å¯¹è¯æ¡†æµ‹è¯•å®Œæˆ');
                
                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;
                
                results.push('');
                results.push(`ğŸ‰ å®Œæ•´æ–‡ä»¶æ“ä½œæµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼`);
                results.push(`â±ï¸  æ€»è€—æ—¶: ${duration.toFixed(2)} ç§’`);
                results.push(`ğŸ“Š æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`);
                
                showResult('full-test-result', {
                    status: 'æ–‡ä»¶æ“ä½œæµ‹è¯•å¥—ä»¶æ‰§è¡ŒæˆåŠŸ',
                    duration: `${duration.toFixed(2)} ç§’`,
                    results: results,
                    timestamp: new Date().toISOString()
                });
                
                log(`å®Œæ•´æ–‡ä»¶æ“ä½œæµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶ ${duration.toFixed(2)} ç§’`);
                
            } catch (error) {
                showError('full-test-result', error);
                log('æ–‡ä»¶æ“ä½œæµ‹è¯•å¥—ä»¶æ‰§è¡Œå¤±è´¥: ' + error.toString());
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥
        checkConnection();
    </script>
</body>
</html>
