<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件操作功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.danger {
            background: #dc3545;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .result.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .result.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MingLog 文件操作功能测试</h1>
        
        <div id="connection-status" class="status disconnected">
            连接状态: 检查中...
        </div>
        
        <div class="test-grid">
            <div class="test-section">
                <h3>Markdown 导入测试</h3>
                <p>测试从Markdown文件导入页面和块的功能</p>
                <button onclick="testMarkdownImport()">测试导入功能</button>
                <div id="import-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>页面导出测试</h3>
                <p>测试将页面导出为Markdown文件的功能</p>
                <button onclick="testPageExport()">测试导出功能</button>
                <div id="export-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>数据备份测试</h3>
                <p>测试创建完整数据备份的功能</p>
                <button onclick="testCreateBackup()">测试备份功能</button>
                <div id="backup-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>文件对话框测试</h3>
                <p>测试文件选择对话框功能</p>
                <button onclick="testFileDialog()">测试文件对话框</button>
                <div id="dialog-result" class="result"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>完整文件操作测试</h3>
            <button class="success" onclick="runFullFileOperationTest()" style="font-size: 16px; padding: 12px 24px;">运行完整文件操作测试</button>
            <div id="full-test-result" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { invoke } from '@tauri-apps/api/core';
        
        // 检查连接状态
        async function checkConnection() {
            try {
                await invoke('get_app_info');
                document.getElementById('connection-status').textContent = '连接状态: 已连接';
                document.getElementById('connection-status').className = 'status connected';
                return true;
            } catch (error) {
                document.getElementById('connection-status').textContent = '连接状态: 未连接 - ' + error.toString();
                document.getElementById('connection-status').className = 'status disconnected';
                return false;
            }
        }
        
        // 辅助函数
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        function showError(elementId, error) {
            showResult(elementId, { error: error.toString() }, true);
        }
        
        function log(message) {
            console.log(`[${new Date().toISOString()}] ${message}`);
        }
        
        // 测试函数
        window.testMarkdownImport = async function() {
            try {
                log('开始测试Markdown导入功能');
                
                const result = await invoke('import_markdown_files_with_dialog', {
                    graphId: 'default'
                });
                
                showResult('import-result', {
                    message: '导入测试完成',
                    result: result,
                    timestamp: new Date().toISOString()
                });
                
                log(`导入测试完成: ${result.pages_imported} 页面, ${result.blocks_imported} 块`);
            } catch (error) {
                log('导入测试失败: ' + error.toString());
                showError('import-result', error);
            }
        };
        
        window.testPageExport = async function() {
            try {
                log('开始测试页面导出功能');
                
                // 首先获取所有页面
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });
                
                if (pages.length === 0) {
                    showResult('export-result', {
                        message: '没有页面可导出，请先创建一些页面',
                        timestamp: new Date().toISOString()
                    }, true);
                    return;
                }
                
                const pageIds = pages.map(page => page.id);
                
                const result = await invoke('export_pages_with_dialog', {
                    pageIds: pageIds
                });
                
                showResult('export-result', {
                    message: '导出测试完成',
                    result: result,
                    pages_count: pages.length,
                    timestamp: new Date().toISOString()
                });
                
                log(`导出测试完成: ${result.files_exported} 文件, ${result.total_size} 字节`);
            } catch (error) {
                log('导出测试失败: ' + error.toString());
                showError('export-result', error);
            }
        };
        
        window.testCreateBackup = async function() {
            try {
                log('开始测试备份创建功能');
                
                const backupPath = await invoke('create_backup_with_dialog');
                
                showResult('backup-result', {
                    message: '备份创建成功',
                    backup_path: backupPath,
                    timestamp: new Date().toISOString()
                });
                
                log(`备份创建成功: ${backupPath}`);
            } catch (error) {
                log('备份创建失败: ' + error.toString());
                showError('backup-result', error);
            }
        };
        
        window.testFileDialog = async function() {
            try {
                log('开始测试文件对话框功能');
                
                // 测试打开文件对话框
                const files = await invoke('open_file_dialog', {
                    filters: [['Markdown Files', ['md', 'txt']]],
                    multiple: true
                });
                
                // 测试保存文件对话框
                const saveFile = await invoke('save_file_dialog', {
                    defaultName: 'test.md',
                    filters: [['Markdown Files', ['md']]]
                });
                
                // 测试选择文件夹对话框
                const folder = await invoke('select_folder_dialog');
                
                showResult('dialog-result', {
                    message: '文件对话框测试完成',
                    open_files: files,
                    save_file: saveFile,
                    selected_folder: folder,
                    timestamp: new Date().toISOString()
                });
                
                log('文件对话框测试完成');
            } catch (error) {
                log('文件对话框测试失败: ' + error.toString());
                showError('dialog-result', error);
            }
        };
        
        window.runFullFileOperationTest = async function() {
            const startTime = Date.now();
            log('开始运行完整文件操作测试套件');
            
            try {
                let results = [];
                
                // 1. 导入测试
                results.push('1. 测试Markdown导入功能...');
                await testMarkdownImport();
                results.push('   ✅ 导入功能测试完成');
                
                // 等待一下
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 2. 导出测试
                results.push('2. 测试页面导出功能...');
                await testPageExport();
                results.push('   ✅ 导出功能测试完成');
                
                // 等待一下
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 3. 备份测试
                results.push('3. 测试备份创建功能...');
                await testCreateBackup();
                results.push('   ✅ 备份功能测试完成');
                
                // 等待一下
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 4. 文件对话框测试
                results.push('4. 测试文件对话框功能...');
                await testFileDialog();
                results.push('   ✅ 文件对话框测试完成');
                
                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;
                
                results.push('');
                results.push(`🎉 完整文件操作测试套件执行完成！`);
                results.push(`⏱️  总耗时: ${duration.toFixed(2)} 秒`);
                results.push(`📊 测试时间: ${new Date().toLocaleString('zh-CN')}`);
                
                showResult('full-test-result', {
                    status: '文件操作测试套件执行成功',
                    duration: `${duration.toFixed(2)} 秒`,
                    results: results,
                    timestamp: new Date().toISOString()
                });
                
                log(`完整文件操作测试套件执行完成，耗时 ${duration.toFixed(2)} 秒`);
                
            } catch (error) {
                showError('full-test-result', error);
                log('文件操作测试套件执行失败: ' + error.toString());
            }
        };
        
        // 页面加载时检查连接
        checkConnection();
    </script>
</body>
</html>
