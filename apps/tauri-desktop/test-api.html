<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MingLog Tauri API 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>MingLog Tauri API 测试</h1>
    
    <div id="connection-status" class="status disconnected">
        连接状态: 未连接
    </div>
    
    <div class="test-section">
        <h2>应用信息</h2>
        <button onclick="testAppInfo()">获取应用信息</button>
        <button onclick="testInitApp()">初始化应用</button>
        <div id="app-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>数据库</h2>
        <button onclick="testInitDatabase()">初始化数据库</button>
        <div id="db-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>页面管理</h2>
        <button onclick="testCreatePage()">创建测试页面</button>
        <button onclick="testGetPages()">获取所有页面</button>
        <button onclick="testCreateSampleData()">创建示例数据</button>
        <div id="page-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>块管理</h2>
        <button onclick="testCreateBlock()">创建测试块</button>
        <button onclick="testGetBlocks()">获取块列表</button>
        <div id="block-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>搜索功能</h2>
        <button onclick="testSearch()">搜索块</button>
        <div id="search-result" class="result"></div>
    </div>

    <script type="module">
        import { invoke } from '@tauri-apps/api/core';
        
        window.invoke = invoke;
        
        // Store test data
        window.testPageId = null;
        window.testBlockId = null;
        
        // Check connection status
        async function checkConnection() {
            try {
                await invoke('get_app_info');
                document.getElementById('connection-status').textContent = '连接状态: 已连接';
                document.getElementById('connection-status').className = 'status connected';
                return true;
            } catch (error) {
                document.getElementById('connection-status').textContent = '连接状态: 未连接 - ' + error.toString();
                document.getElementById('connection-status').className = 'status disconnected';
                return false;
            }
        }
        
        // Check connection on load
        checkConnection();
        
        // Helper functions
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        function showError(elementId, error) {
            showResult(elementId, { error: error.toString() }, true);
        }
        
        // Test functions
        window.testAppInfo = async function() {
            try {
                const result = await invoke('get_app_info');
                showResult('app-result', result);
                checkConnection();
            } catch (error) {
                showError('app-result', error);
                checkConnection();
            }
        };
        
        window.testInitApp = async function() {
            try {
                const result = await invoke('init_app');
                showResult('app-result', { message: result });
            } catch (error) {
                showError('app-result', error);
            }
        };
        
        window.testInitDatabase = async function() {
            try {
                const result = await invoke('init_database');
                showResult('db-result', { message: result });
            } catch (error) {
                showError('db-result', error);
            }
        };
        
        window.testCreatePage = async function() {
            try {
                const request = {
                    graph_id: 'default',
                    name: '测试页面 ' + Date.now(),
                    title: '测试页面标题',
                    tags: JSON.stringify(['测试', 'API']),
                    is_journal: false
                };
                const result = await invoke('create_page', { request });
                window.testPageId = result.id;
                showResult('page-result', result);
            } catch (error) {
                showError('page-result', error);
            }
        };
        
        window.testGetPages = async function() {
            try {
                const result = await invoke('get_pages_by_graph', { graphId: 'default' });
                showResult('page-result', result);
            } catch (error) {
                showError('page-result', error);
            }
        };
        
        window.testCreateSampleData = async function() {
            try {
                await invoke('create_sample_graph_data');
                showResult('page-result', { message: '示例数据创建成功' });
            } catch (error) {
                showError('page-result', error);
            }
        };
        
        window.testCreateBlock = async function() {
            if (!window.testPageId) {
                showError('block-result', '请先创建一个页面');
                return;
            }
            
            try {
                const request = {
                    graph_id: 'default',
                    page_id: window.testPageId,
                    content: '这是一个测试块，创建于 ' + new Date().toLocaleString('zh-CN'),
                    order: 0
                };
                const result = await invoke('create_block', { request });
                window.testBlockId = result.id;
                showResult('block-result', result);
            } catch (error) {
                showError('block-result', error);
            }
        };
        
        window.testGetBlocks = async function() {
            if (!window.testPageId) {
                showError('block-result', '请先创建一个页面');
                return;
            }
            
            try {
                const result = await invoke('get_blocks_by_page', { pageId: window.testPageId });
                showResult('block-result', result);
            } catch (error) {
                showError('block-result', error);
            }
        };
        
        window.testSearch = async function() {
            try {
                const request = {
                    query: '测试',
                    include_pages: true,
                    include_blocks: true,
                    limit: 10
                };
                const result = await invoke('search_blocks', { request });
                showResult('search-result', result);
            } catch (error) {
                showError('search-result', error);
            }
        };
    </script>
</body>
</html>
