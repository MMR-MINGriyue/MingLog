<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MingLog å…¨é¢åŠŸèƒ½æµ‹è¯•å¥—ä»¶</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-overview {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .test-overview h2 {
            margin: 0 0 15px 0;
            color: #1976d2;
        }
        .test-category {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-category h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .test-item {
            background: white;
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .test-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-item h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }
        .test-item p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 3px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.danger {
            background: #dc3545;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .status.testing {
            background: #fff3cd;
            color: #856404;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 11px;
        }
        .result.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .result.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s ease;
        }
        .test-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e1e5e9;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª MingLog å…¨é¢åŠŸèƒ½æµ‹è¯•å¥—ä»¶</h1>
        
        <div class="test-overview">
            <h2>æµ‹è¯•å¥—ä»¶æ¦‚è§ˆ</h2>
            <p>è¿™æ˜¯MingLogæ¡Œé¢åº”ç”¨çš„å…¨é¢åŠŸèƒ½æµ‹è¯•å¥—ä»¶ï¼Œæ¶µç›–äº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ¨¡å—çš„è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚æµ‹è¯•å¥—ä»¶åŒ…æ‹¬æ•°æ®åº“æ“ä½œã€æ–‡ä»¶æ“ä½œã€WebDAVåŒæ­¥ã€ç”¨æˆ·ç•Œé¢äº¤äº’ç­‰å„ä¸ªæ–¹é¢ã€‚</p>
            <p><strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>ç¡®ä¿åº”ç”¨çš„ç¨³å®šæ€§ã€å¯é æ€§å’Œç”¨æˆ·ä½“éªŒè´¨é‡ã€‚</p>
        </div>
        
        <div id="connection-status" class="status disconnected">
            è¿æ¥çŠ¶æ€: æ£€æŸ¥ä¸­...
        </div>
        
        <div class="control-panel">
            <button onclick="runAllTests()" class="success" style="font-size: 16px; padding: 12px 24px; margin: 0 10px;">ğŸš€ è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
            <button onclick="runCriticalTests()" class="warning" style="font-size: 16px; padding: 12px 24px; margin: 0 10px;">âš¡ è¿è¡Œå…³é”®æµ‹è¯•</button>
            <button onclick="stopAllTests()" class="danger" style="font-size: 16px; padding: 12px 24px; margin: 0 10px;">ğŸ›‘ åœæ­¢æµ‹è¯•</button>
        </div>
        
        <div class="progress">
            <div id="overall-progress" class="progress-bar" style="width: 0%"></div>
        </div>
        
        <div class="test-stats">
            <div class="stat-card">
                <div id="total-tests" class="stat-number">0</div>
                <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
            </div>
            <div class="stat-card">
                <div id="passed-tests" class="stat-number">0</div>
                <div class="stat-label">é€šè¿‡æµ‹è¯•</div>
            </div>
            <div class="stat-card">
                <div id="failed-tests" class="stat-number">0</div>
                <div class="stat-label">å¤±è´¥æµ‹è¯•</div>
            </div>
            <div class="stat-card">
                <div id="test-duration" class="stat-number">0s</div>
                <div class="stat-label">æµ‹è¯•è€—æ—¶</div>
            </div>
        </div>
        
        <div class="test-category">
            <h3>ğŸ—„ï¸ æ•°æ®åº“åŠŸèƒ½æµ‹è¯•</h3>
            <div class="test-grid">
                <div class="test-item">
                    <h4>æ•°æ®åº“è¿æ¥æµ‹è¯•</h4>
                    <p>æµ‹è¯•SQLiteæ•°æ®åº“è¿æ¥å’Œåˆå§‹åŒ–</p>
                    <button onclick="testDatabaseConnection()">è¿è¡Œæµ‹è¯•</button>
                    <div id="db-connection-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>é¡µé¢CRUDæµ‹è¯•</h4>
                    <p>æµ‹è¯•é¡µé¢çš„åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤æ“ä½œ</p>
                    <button onclick="testPageCRUD()">è¿è¡Œæµ‹è¯•</button>
                    <div id="page-crud-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>å—CRUDæµ‹è¯•</h4>
                    <p>æµ‹è¯•å—çš„åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤æ“ä½œ</p>
                    <button onclick="testBlockCRUD()">è¿è¡Œæµ‹è¯•</button>
                    <div id="block-crud-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>æ•°æ®å®Œæ•´æ€§æµ‹è¯•</h4>
                    <p>æµ‹è¯•æ•°æ®å…³è”å…³ç³»å’Œçº¦æŸ</p>
                    <button onclick="testDataIntegrity()">è¿è¡Œæµ‹è¯•</button>
                    <div id="data-integrity-result" class="result"></div>
                </div>
            </div>
        </div>
        
        <div class="test-category">
            <h3>ğŸ“ æ–‡ä»¶æ“ä½œæµ‹è¯•</h3>
            <div class="test-grid">
                <div class="test-item">
                    <h4>Markdownå¯¼å…¥æµ‹è¯•</h4>
                    <p>æµ‹è¯•Markdownæ–‡ä»¶å¯¼å…¥åŠŸèƒ½</p>
                    <button onclick="testMarkdownImport()">è¿è¡Œæµ‹è¯•</button>
                    <div id="markdown-import-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>é¡µé¢å¯¼å‡ºæµ‹è¯•</h4>
                    <p>æµ‹è¯•é¡µé¢å¯¼å‡ºä¸ºMarkdownæ–‡ä»¶</p>
                    <button onclick="testPageExport()">è¿è¡Œæµ‹è¯•</button>
                    <div id="page-export-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>æ•°æ®å¤‡ä»½æµ‹è¯•</h4>
                    <p>æµ‹è¯•å®Œæ•´æ•°æ®å¤‡ä»½åŠŸèƒ½</p>
                    <button onclick="testDataBackup()">è¿è¡Œæµ‹è¯•</button>
                    <div id="data-backup-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>æ–‡ä»¶ç³»ç»Ÿæƒé™æµ‹è¯•</h4>
                    <p>æµ‹è¯•æ–‡ä»¶è¯»å†™æƒé™å’Œé”™è¯¯å¤„ç†</p>
                    <button onclick="testFilePermissions()">è¿è¡Œæµ‹è¯•</button>
                    <div id="file-permissions-result" class="result"></div>
                </div>
            </div>
        </div>
        
        <div class="test-category">
            <h3>ğŸ”„ WebDAVåŒæ­¥æµ‹è¯•</h3>
            <div class="test-grid">
                <div class="test-item">
                    <h4>åŒæ­¥é…ç½®æµ‹è¯•</h4>
                    <p>æµ‹è¯•WebDAVé…ç½®ç®¡ç†</p>
                    <button onclick="testSyncConfig()">è¿è¡Œæµ‹è¯•</button>
                    <div id="sync-config-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>è¿æ¥æµ‹è¯•</h4>
                    <p>æµ‹è¯•WebDAVæœåŠ¡å™¨è¿æ¥</p>
                    <button onclick="testSyncConnection()">è¿è¡Œæµ‹è¯•</button>
                    <div id="sync-connection-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>åŒæ­¥æ“ä½œæµ‹è¯•</h4>
                    <p>æµ‹è¯•åŒæ­¥å¯åŠ¨ã€åœæ­¢å’ŒçŠ¶æ€ç®¡ç†</p>
                    <button onclick="testSyncOperations()">è¿è¡Œæµ‹è¯•</button>
                    <div id="sync-operations-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>å†²çªå¤„ç†æµ‹è¯•</h4>
                    <p>æµ‹è¯•åŒæ­¥å†²çªæ£€æµ‹å’Œè§£å†³</p>
                    <button onclick="testConflictHandling()">è¿è¡Œæµ‹è¯•</button>
                    <div id="conflict-handling-result" class="result"></div>
                </div>
            </div>
        </div>
        
        <div class="test-category">
            <h3>ğŸ¨ ç”¨æˆ·ç•Œé¢æµ‹è¯•</h3>
            <div class="test-grid">
                <div class="test-item">
                    <h4>åº”ç”¨å¯åŠ¨æµ‹è¯•</h4>
                    <p>æµ‹è¯•åº”ç”¨å¯åŠ¨å’Œåˆå§‹åŒ–</p>
                    <button onclick="testAppStartup()">è¿è¡Œæµ‹è¯•</button>
                    <div id="app-startup-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>é¡µé¢å¯¼èˆªæµ‹è¯•</h4>
                    <p>æµ‹è¯•é¡µé¢åˆ‡æ¢å’Œå¯¼èˆªåŠŸèƒ½</p>
                    <button onclick="testPageNavigation()">è¿è¡Œæµ‹è¯•</button>
                    <div id="page-navigation-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>ç¼–è¾‘å™¨åŠŸèƒ½æµ‹è¯•</h4>
                    <p>æµ‹è¯•å—ç¼–è¾‘å™¨çš„å„é¡¹åŠŸèƒ½</p>
                    <button onclick="testEditorFunctions()">è¿è¡Œæµ‹è¯•</button>
                    <div id="editor-functions-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>å“åº”æ€§æµ‹è¯•</h4>
                    <p>æµ‹è¯•ç•Œé¢å“åº”é€Ÿåº¦å’Œæ€§èƒ½</p>
                    <button onclick="testUIResponsiveness()">è¿è¡Œæµ‹è¯•</button>
                    <div id="ui-responsiveness-result" class="result"></div>
                </div>
            </div>
        </div>
        
        <div class="test-category">
            <h3>âš¡ æ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•</h3>
            <div class="test-grid">
                <div class="test-item">
                    <h4>å†…å­˜ä½¿ç”¨æµ‹è¯•</h4>
                    <p>æµ‹è¯•åº”ç”¨å†…å­˜ä½¿ç”¨æƒ…å†µ</p>
                    <button onclick="testMemoryUsage()">è¿è¡Œæµ‹è¯•</button>
                    <div id="memory-usage-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>å¹¶å‘æ“ä½œæµ‹è¯•</h4>
                    <p>æµ‹è¯•å¤šä¸ªæ“ä½œåŒæ—¶æ‰§è¡Œ</p>
                    <button onclick="testConcurrentOperations()">è¿è¡Œæµ‹è¯•</button>
                    <div id="concurrent-operations-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>é”™è¯¯æ¢å¤æµ‹è¯•</h4>
                    <p>æµ‹è¯•é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶</p>
                    <button onclick="testErrorRecovery()">è¿è¡Œæµ‹è¯•</button>
                    <div id="error-recovery-result" class="result"></div>
                </div>
                <div class="test-item">
                    <h4>é•¿æ—¶é—´è¿è¡Œæµ‹è¯•</h4>
                    <p>æµ‹è¯•åº”ç”¨é•¿æ—¶é—´è¿è¡Œçš„ç¨³å®šæ€§</p>
                    <button onclick="testLongRunning()">è¿è¡Œæµ‹è¯•</button>
                    <div id="long-running-result" class="result"></div>
                </div>
            </div>
        </div>
        
        <div class="test-category">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»</h3>
            <div id="test-summary" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { invoke } from '@tauri-apps/api/core';
        
        // å…¨å±€æµ‹è¯•çŠ¶æ€
        window.testState = {
            totalTests: 0,
            passedTests: 0,
            failedTests: 0,
            startTime: null,
            isRunning: false,
            results: []
        };
        
        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                await invoke('get_app_info');
                document.getElementById('connection-status').textContent = 'è¿æ¥çŠ¶æ€: å·²è¿æ¥åˆ°MingLog';
                document.getElementById('connection-status').className = 'status connected';
                return true;
            } catch (error) {
                document.getElementById('connection-status').textContent = 'è¿æ¥çŠ¶æ€: æœªè¿æ¥ - ' + error.toString();
                document.getElementById('connection-status').className = 'status disconnected';
                return false;
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = JSON.stringify(data, null, 2);
                element.className = `result ${isError ? 'error' : 'success'}`;
            }
        }

        function showError(elementId, error) {
            showResult(elementId, { error: error.toString() }, true);
        }

        function log(message) {
            console.log(`[${new Date().toISOString()}] ${message}`);
        }

        function updateProgress(percent) {
            document.getElementById('overall-progress').style.width = percent + '%';
        }

        function updateStats() {
            document.getElementById('total-tests').textContent = window.testState.totalTests;
            document.getElementById('passed-tests').textContent = window.testState.passedTests;
            document.getElementById('failed-tests').textContent = window.testState.failedTests;

            if (window.testState.startTime) {
                const duration = (Date.now() - window.testState.startTime) / 1000;
                document.getElementById('test-duration').textContent = duration.toFixed(1) + 's';
            }
        }

        async function runTest(testName, testFunction) {
            window.testState.totalTests++;
            updateStats();

            try {
                log(`å¼€å§‹æµ‹è¯•: ${testName}`);
                const result = await testFunction();
                window.testState.passedTests++;
                window.testState.results.push({ name: testName, status: 'PASSED', result });
                log(`æµ‹è¯•é€šè¿‡: ${testName}`);
                return result;
            } catch (error) {
                window.testState.failedTests++;
                window.testState.results.push({ name: testName, status: 'FAILED', error: error.toString() });
                log(`æµ‹è¯•å¤±è´¥: ${testName} - ${error.toString()}`);
                throw error;
            } finally {
                updateStats();
            }
        }

        // æ•°æ®åº“åŠŸèƒ½æµ‹è¯•
        window.testDatabaseConnection = async function() {
            return await runTest('æ•°æ®åº“è¿æ¥æµ‹è¯•', async () => {
                const appInfo = await invoke('get_app_info');
                const result = await invoke('init_database');

                showResult('db-connection-result', {
                    message: 'æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ',
                    app_info: appInfo,
                    init_result: result,
                    timestamp: new Date().toISOString()
                });

                return { status: 'success', app_info: appInfo };
            });
        };

        window.testPageCRUD = async function() {
            return await runTest('é¡µé¢CRUDæµ‹è¯•', async () => {
                // åˆ›å»ºæµ‹è¯•é¡µé¢
                const createRequest = {
                    graph_id: 'default',
                    name: `æµ‹è¯•é¡µé¢_${Date.now()}`,
                    title: 'é¡µé¢CRUDæµ‹è¯•',
                    tags: JSON.stringify(['æµ‹è¯•', 'CRUD']),
                    is_journal: false
                };

                const createdPage = await invoke('create_page', { request: createRequest });

                // è¯»å–é¡µé¢
                const retrievedPage = await invoke('get_page', { id: createdPage.id });

                // æ›´æ–°é¡µé¢
                const updateRequest = {
                    id: createdPage.id,
                    title: 'æ›´æ–°åçš„é¡µé¢æ ‡é¢˜'
                };
                const updatedPage = await invoke('update_page', { request: updateRequest });

                // åˆ é™¤é¡µé¢
                await invoke('delete_page', { id: createdPage.id });

                const result = {
                    created: createdPage,
                    retrieved: retrievedPage,
                    updated: updatedPage,
                    deleted: true
                };

                showResult('page-crud-result', {
                    message: 'é¡µé¢CRUDæµ‹è¯•æˆåŠŸ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testBlockCRUD = async function() {
            return await runTest('å—CRUDæµ‹è¯•', async () => {
                // å…ˆåˆ›å»ºä¸€ä¸ªé¡µé¢
                const pageRequest = {
                    graph_id: 'default',
                    name: `å—æµ‹è¯•é¡µé¢_${Date.now()}`,
                    title: 'å—CRUDæµ‹è¯•é¡µé¢',
                    tags: JSON.stringify(['æµ‹è¯•']),
                    is_journal: false
                };

                const testPage = await invoke('create_page', { request: pageRequest });

                // åˆ›å»ºæµ‹è¯•å—
                const createRequest = {
                    graph_id: 'default',
                    page_id: testPage.id,
                    content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å—',
                    order: 0
                };

                const createdBlock = await invoke('create_block', { request: createRequest });

                // è¯»å–å—
                const blocks = await invoke('get_blocks_by_page', { pageId: testPage.id });

                // æ›´æ–°å—
                const updateRequest = {
                    id: createdBlock.id,
                    content: 'è¿™æ˜¯æ›´æ–°åçš„æµ‹è¯•å—'
                };
                const updatedBlock = await invoke('update_block', { request: updateRequest });

                // åˆ é™¤å—
                await invoke('delete_block', { id: createdBlock.id });

                // æ¸…ç†æµ‹è¯•é¡µé¢
                await invoke('delete_page', { id: testPage.id });

                const result = {
                    page: testPage,
                    created: createdBlock,
                    retrieved: blocks,
                    updated: updatedBlock,
                    deleted: true
                };

                showResult('block-crud-result', {
                    message: 'å—CRUDæµ‹è¯•æˆåŠŸ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testDataIntegrity = async function() {
            return await runTest('æ•°æ®å®Œæ•´æ€§æµ‹è¯•', async () => {
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });
                let totalBlocks = 0;
                let integrityIssues = [];

                for (const page of pages) {
                    try {
                        const blocks = await invoke('get_blocks_by_page', { pageId: page.id });
                        totalBlocks += blocks.length;

                        // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                        for (const block of blocks) {
                            if (block.page_id !== page.id) {
                                integrityIssues.push(`å— ${block.id} çš„ page_id ä¸åŒ¹é…`);
                            }
                            if (block.graph_id !== page.graph_id) {
                                integrityIssues.push(`å— ${block.id} çš„ graph_id ä¸åŒ¹é…`);
                            }
                        }
                    } catch (error) {
                        integrityIssues.push(`æ— æ³•è·å–é¡µé¢ ${page.id} çš„å—: ${error.toString()}`);
                    }
                }

                const result = {
                    totalPages: pages.length,
                    totalBlocks: totalBlocks,
                    integrityIssues: integrityIssues,
                    status: integrityIssues.length === 0 ? 'æ•°æ®å®Œæ•´æ€§è‰¯å¥½' : 'å‘ç°å®Œæ•´æ€§é—®é¢˜'
                };

                showResult('data-integrity-result', {
                    message: 'æ•°æ®å®Œæ•´æ€§æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                }, integrityIssues.length > 0);

                return result;
            });
        };

        // æ–‡ä»¶æ“ä½œæµ‹è¯•
        window.testMarkdownImport = async function() {
            return await runTest('Markdownå¯¼å…¥æµ‹è¯•', async () => {
                const result = await invoke('import_markdown_files_with_dialog', {
                    graphId: 'default'
                });

                showResult('markdown-import-result', {
                    message: 'Markdownå¯¼å…¥æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testPageExport = async function() {
            return await runTest('é¡µé¢å¯¼å‡ºæµ‹è¯•', async () => {
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });

                if (pages.length === 0) {
                    throw new Error('æ²¡æœ‰é¡µé¢å¯å¯¼å‡º');
                }

                const pageIds = pages.slice(0, 2).map(page => page.id); // åªå¯¼å‡ºå‰2ä¸ªé¡µé¢
                const result = await invoke('export_pages_with_dialog', { pageIds });

                showResult('page-export-result', {
                    message: 'é¡µé¢å¯¼å‡ºæµ‹è¯•å®Œæˆ',
                    result: result,
                    pages_count: pageIds.length,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testDataBackup = async function() {
            return await runTest('æ•°æ®å¤‡ä»½æµ‹è¯•', async () => {
                const backupPath = await invoke('create_backup_with_dialog');

                showResult('data-backup-result', {
                    message: 'æ•°æ®å¤‡ä»½æµ‹è¯•å®Œæˆ',
                    backup_path: backupPath,
                    timestamp: new Date().toISOString()
                });

                return { backup_path: backupPath };
            });
        };

        window.testFilePermissions = async function() {
            return await runTest('æ–‡ä»¶ç³»ç»Ÿæƒé™æµ‹è¯•', async () => {
                // æµ‹è¯•åº”ç”¨ä¿¡æ¯è·å–ï¼ˆé—´æ¥æµ‹è¯•æ–‡ä»¶ç³»ç»Ÿè®¿é—®ï¼‰
                const appInfo = await invoke('get_app_info');

                // æµ‹è¯•æ•°æ®åº“è®¿é—®
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });

                const result = {
                    app_info_accessible: !!appInfo,
                    database_accessible: Array.isArray(pages),
                    permissions_ok: true
                };

                showResult('file-permissions-result', {
                    message: 'æ–‡ä»¶ç³»ç»Ÿæƒé™æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        // WebDAVåŒæ­¥æµ‹è¯•
        window.testSyncConfig = async function() {
            return await runTest('åŒæ­¥é…ç½®æµ‹è¯•', async () => {
                const testConfig = {
                    server_url: "https://dav.jianguoyun.com/dav/",
                    username: "test@example.com",
                    password: "test-password",
                    remote_path: "/minglog/",
                    enabled: true,
                    auto_sync_interval: 300
                };

                await invoke('configure_webdav_sync', { config: testConfig });
                const retrievedConfig = await invoke('get_webdav_config');

                const result = {
                    config_saved: !!retrievedConfig,
                    config_matches: retrievedConfig && retrievedConfig.server_url === testConfig.server_url
                };

                showResult('sync-config-result', {
                    message: 'åŒæ­¥é…ç½®æµ‹è¯•å®Œæˆ',
                    result: result,
                    config: retrievedConfig ? { ...retrievedConfig, password: '***' } : null,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testSyncConnection = async function() {
            return await runTest('åŒæ­¥è¿æ¥æµ‹è¯•', async () => {
                const isConnected = await invoke('test_webdav_connection');

                const result = {
                    connection_test_completed: true,
                    connection_result: isConnected
                };

                showResult('sync-connection-result', {
                    message: 'åŒæ­¥è¿æ¥æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testSyncOperations = async function() {
            return await runTest('åŒæ­¥æ“ä½œæµ‹è¯•', async () => {
                // è·å–åˆå§‹çŠ¶æ€
                const initialStatus = await invoke('get_sync_status');

                // å¼€å§‹åŒæ­¥
                const syncResult = await invoke('start_webdav_sync', { direction: 'Upload' });

                // ç­‰å¾…ä¸€ä¸‹
                await new Promise(resolve => setTimeout(resolve, 500));

                // åœæ­¢åŒæ­¥
                await invoke('stop_webdav_sync');

                // è·å–æœ€ç»ˆçŠ¶æ€
                const finalStatus = await invoke('get_sync_status');

                const result = {
                    initial_status: initialStatus,
                    sync_result: syncResult,
                    final_status: finalStatus,
                    operations_completed: true
                };

                showResult('sync-operations-result', {
                    message: 'åŒæ­¥æ“ä½œæµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testConflictHandling = async function() {
            return await runTest('å†²çªå¤„ç†æµ‹è¯•', async () => {
                const conflicts = await invoke('get_sync_conflicts');

                const result = {
                    conflicts_checked: true,
                    conflicts_count: conflicts.length,
                    conflicts: conflicts
                };

                showResult('conflict-handling-result', {
                    message: 'å†²çªå¤„ç†æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        // ç”¨æˆ·ç•Œé¢æµ‹è¯•
        window.testAppStartup = async function() {
            return await runTest('åº”ç”¨å¯åŠ¨æµ‹è¯•', async () => {
                const appInfo = await invoke('get_app_info');
                const dbInit = await invoke('init_database');

                const result = {
                    app_info_loaded: !!appInfo,
                    database_initialized: !!dbInit,
                    startup_successful: true
                };

                showResult('app-startup-result', {
                    message: 'åº”ç”¨å¯åŠ¨æµ‹è¯•å®Œæˆ',
                    result: result,
                    app_info: appInfo,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testPageNavigation = async function() {
            return await runTest('é¡µé¢å¯¼èˆªæµ‹è¯•', async () => {
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });

                let navigationTests = [];
                for (let i = 0; i < Math.min(3, pages.length); i++) {
                    const page = pages[i];
                    const retrievedPage = await invoke('get_page', { id: page.id });
                    const blocks = await invoke('get_blocks_by_page', { pageId: page.id });

                    navigationTests.push({
                        page_id: page.id,
                        page_loaded: !!retrievedPage,
                        blocks_loaded: Array.isArray(blocks)
                    });
                }

                const result = {
                    total_pages: pages.length,
                    navigation_tests: navigationTests,
                    all_successful: navigationTests.every(test => test.page_loaded && test.blocks_loaded)
                };

                showResult('page-navigation-result', {
                    message: 'é¡µé¢å¯¼èˆªæµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testEditorFunctions = async function() {
            return await runTest('ç¼–è¾‘å™¨åŠŸèƒ½æµ‹è¯•', async () => {
                // åˆ›å»ºæµ‹è¯•é¡µé¢
                const pageRequest = {
                    graph_id: 'default',
                    name: `ç¼–è¾‘å™¨æµ‹è¯•é¡µé¢_${Date.now()}`,
                    title: 'ç¼–è¾‘å™¨åŠŸèƒ½æµ‹è¯•',
                    tags: JSON.stringify(['ç¼–è¾‘å™¨', 'æµ‹è¯•']),
                    is_journal: false
                };

                const testPage = await invoke('create_page', { request: pageRequest });

                // æµ‹è¯•å—åˆ›å»º
                const blockRequest = {
                    graph_id: 'default',
                    page_id: testPage.id,
                    content: 'è¿™æ˜¯ç¼–è¾‘å™¨æµ‹è¯•å—',
                    order: 0
                };

                const testBlock = await invoke('create_block', { request: blockRequest });

                // æµ‹è¯•å—æ›´æ–°
                const updateRequest = {
                    id: testBlock.id,
                    content: 'è¿™æ˜¯æ›´æ–°åçš„ç¼–è¾‘å™¨æµ‹è¯•å—'
                };

                const updatedBlock = await invoke('update_block', { request: updateRequest });

                // æ¸…ç†
                await invoke('delete_page', { id: testPage.id });

                const result = {
                    page_creation: !!testPage,
                    block_creation: !!testBlock,
                    block_update: !!updatedBlock,
                    editor_functions_working: true
                };

                showResult('editor-functions-result', {
                    message: 'ç¼–è¾‘å™¨åŠŸèƒ½æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testUIResponsiveness = async function() {
            return await runTest('å“åº”æ€§æµ‹è¯•', async () => {
                const startTime = Date.now();

                // æµ‹è¯•å¤šä¸ªå¿«é€Ÿæ“ä½œ
                const operations = [];

                // è·å–åº”ç”¨ä¿¡æ¯
                const appInfoStart = Date.now();
                await invoke('get_app_info');
                operations.push({ operation: 'get_app_info', duration: Date.now() - appInfoStart });

                // è·å–é¡µé¢åˆ—è¡¨
                const pagesStart = Date.now();
                await invoke('get_pages_by_graph', { graphId: 'default' });
                operations.push({ operation: 'get_pages', duration: Date.now() - pagesStart });

                // è·å–åŒæ­¥çŠ¶æ€
                const syncStart = Date.now();
                await invoke('get_sync_status');
                operations.push({ operation: 'get_sync_status', duration: Date.now() - syncStart });

                const totalDuration = Date.now() - startTime;
                const avgDuration = operations.reduce((sum, op) => sum + op.duration, 0) / operations.length;

                const result = {
                    total_duration: totalDuration,
                    average_operation_duration: avgDuration,
                    operations: operations,
                    responsive: avgDuration < 1000 // å¹³å‡å“åº”æ—¶é—´å°äº1ç§’
                };

                showResult('ui-responsiveness-result', {
                    message: 'å“åº”æ€§æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                }, !result.responsive);

                return result;
            });
        };

        // æ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•
        window.testMemoryUsage = async function() {
            return await runTest('å†…å­˜ä½¿ç”¨æµ‹è¯•', async () => {
                // æ¨¡æ‹Ÿå†…å­˜ä½¿ç”¨æµ‹è¯•ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­å¯ä»¥é€šè¿‡æ€§èƒ½APIè·å–ï¼‰
                const beforeMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;

                // æ‰§è¡Œä¸€äº›æ“ä½œ
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });
                for (const page of pages.slice(0, 5)) {
                    await invoke('get_blocks_by_page', { pageId: page.id });
                }

                const afterMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;

                const result = {
                    before_memory: beforeMemory,
                    after_memory: afterMemory,
                    memory_increase: afterMemory - beforeMemory,
                    memory_test_completed: true
                };

                showResult('memory-usage-result', {
                    message: 'å†…å­˜ä½¿ç”¨æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testConcurrentOperations = async function() {
            return await runTest('å¹¶å‘æ“ä½œæµ‹è¯•', async () => {
                const operations = [
                    invoke('get_app_info'),
                    invoke('get_pages_by_graph', { graphId: 'default' }),
                    invoke('get_sync_status'),
                    invoke('test_webdav_connection'),
                    invoke('get_webdav_config')
                ];

                const startTime = Date.now();
                const results = await Promise.all(operations);
                const duration = Date.now() - startTime;

                const result = {
                    concurrent_operations: operations.length,
                    all_successful: results.every(r => r !== null && r !== undefined),
                    total_duration: duration,
                    concurrent_test_passed: true
                };

                showResult('concurrent-operations-result', {
                    message: 'å¹¶å‘æ“ä½œæµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                });

                return result;
            });
        };

        window.testErrorRecovery = async function() {
            return await runTest('é”™è¯¯æ¢å¤æµ‹è¯•', async () => {
                let errorTests = [];

                // æµ‹è¯•æ— æ•ˆé¡µé¢ID
                try {
                    await invoke('get_page', { id: 'invalid-page-id' });
                    errorTests.push({ test: 'invalid_page_id', handled: false });
                } catch (error) {
                    errorTests.push({ test: 'invalid_page_id', handled: true, error: error.toString() });
                }

                // æµ‹è¯•æ— æ•ˆå—ID
                try {
                    await invoke('get_blocks_by_page', { pageId: 'invalid-page-id' });
                    errorTests.push({ test: 'invalid_block_query', handled: false });
                } catch (error) {
                    errorTests.push({ test: 'invalid_block_query', handled: true, error: error.toString() });
                }

                const result = {
                    error_tests: errorTests,
                    all_errors_handled: errorTests.every(test => test.handled),
                    error_recovery_working: true
                };

                showResult('error-recovery-result', {
                    message: 'é”™è¯¯æ¢å¤æµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                }, !result.all_errors_handled);

                return result;
            });
        };

        window.testLongRunning = async function() {
            return await runTest('é•¿æ—¶é—´è¿è¡Œæµ‹è¯•', async () => {
                const startTime = Date.now();
                const iterations = 10;
                let successfulOperations = 0;

                for (let i = 0; i < iterations; i++) {
                    try {
                        await invoke('get_app_info');
                        await new Promise(resolve => setTimeout(resolve, 100)); // ç­‰å¾…100ms
                        successfulOperations++;
                    } catch (error) {
                        console.error(`é•¿æ—¶é—´è¿è¡Œæµ‹è¯•ç¬¬${i+1}æ¬¡è¿­ä»£å¤±è´¥:`, error);
                    }
                }

                const duration = Date.now() - startTime;

                const result = {
                    iterations: iterations,
                    successful_operations: successfulOperations,
                    total_duration: duration,
                    success_rate: (successfulOperations / iterations) * 100,
                    stability_good: successfulOperations === iterations
                };

                showResult('long-running-result', {
                    message: 'é•¿æ—¶é—´è¿è¡Œæµ‹è¯•å®Œæˆ',
                    result: result,
                    timestamp: new Date().toISOString()
                }, !result.stability_good);

                return result;
            });
        };

        // ä¸»è¦æµ‹è¯•æ§åˆ¶å‡½æ•°
        window.runAllTests = async function() {
            if (window.testState.isRunning) {
                alert('æµ‹è¯•æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
                return;
            }

            window.testState.isRunning = true;
            window.testState.startTime = Date.now();
            window.testState.totalTests = 0;
            window.testState.passedTests = 0;
            window.testState.failedTests = 0;
            window.testState.results = [];

            document.getElementById('connection-status').textContent = 'çŠ¶æ€: æ­£åœ¨è¿è¡Œå…¨é¢æµ‹è¯•...';
            document.getElementById('connection-status').className = 'status testing';

            const allTests = [
                // æ•°æ®åº“åŠŸèƒ½æµ‹è¯•
                { name: 'æ•°æ®åº“è¿æ¥æµ‹è¯•', func: testDatabaseConnection },
                { name: 'é¡µé¢CRUDæµ‹è¯•', func: testPageCRUD },
                { name: 'å—CRUDæµ‹è¯•', func: testBlockCRUD },
                { name: 'æ•°æ®å®Œæ•´æ€§æµ‹è¯•', func: testDataIntegrity },

                // æ–‡ä»¶æ“ä½œæµ‹è¯•
                { name: 'Markdownå¯¼å…¥æµ‹è¯•', func: testMarkdownImport },
                { name: 'é¡µé¢å¯¼å‡ºæµ‹è¯•', func: testPageExport },
                { name: 'æ•°æ®å¤‡ä»½æµ‹è¯•', func: testDataBackup },
                { name: 'æ–‡ä»¶æƒé™æµ‹è¯•', func: testFilePermissions },

                // WebDAVåŒæ­¥æµ‹è¯•
                { name: 'åŒæ­¥é…ç½®æµ‹è¯•', func: testSyncConfig },
                { name: 'åŒæ­¥è¿æ¥æµ‹è¯•', func: testSyncConnection },
                { name: 'åŒæ­¥æ“ä½œæµ‹è¯•', func: testSyncOperations },
                { name: 'å†²çªå¤„ç†æµ‹è¯•', func: testConflictHandling },

                // ç”¨æˆ·ç•Œé¢æµ‹è¯•
                { name: 'åº”ç”¨å¯åŠ¨æµ‹è¯•', func: testAppStartup },
                { name: 'é¡µé¢å¯¼èˆªæµ‹è¯•', func: testPageNavigation },
                { name: 'ç¼–è¾‘å™¨åŠŸèƒ½æµ‹è¯•', func: testEditorFunctions },
                { name: 'å“åº”æ€§æµ‹è¯•', func: testUIResponsiveness },

                // æ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•
                { name: 'å†…å­˜ä½¿ç”¨æµ‹è¯•', func: testMemoryUsage },
                { name: 'å¹¶å‘æ“ä½œæµ‹è¯•', func: testConcurrentOperations },
                { name: 'é”™è¯¯æ¢å¤æµ‹è¯•', func: testErrorRecovery },
                { name: 'é•¿æ—¶é—´è¿è¡Œæµ‹è¯•', func: testLongRunning }
            ];

            try {
                for (let i = 0; i < allTests.length; i++) {
                    const test = allTests[i];
                    const progress = ((i + 1) / allTests.length) * 100;
                    updateProgress(progress);

                    try {
                        await test.func();
                        await new Promise(resolve => setTimeout(resolve, 200)); // çŸ­æš‚å»¶è¿Ÿ
                    } catch (error) {
                        console.error(`æµ‹è¯•å¤±è´¥: ${test.name}`, error);
                    }
                }

                // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
                const duration = (Date.now() - window.testState.startTime) / 1000;
                const successRate = (window.testState.passedTests / window.testState.totalTests) * 100;

                const summary = {
                    total_tests: window.testState.totalTests,
                    passed_tests: window.testState.passedTests,
                    failed_tests: window.testState.failedTests,
                    success_rate: successRate.toFixed(1) + '%',
                    duration: duration.toFixed(2) + 'ç§’',
                    status: successRate >= 90 ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•å¤±è´¥',
                    timestamp: new Date().toISOString(),
                    detailed_results: window.testState.results
                };

                showResult('test-summary', summary, successRate < 90);

                document.getElementById('connection-status').textContent =
                    `çŠ¶æ€: å…¨é¢æµ‹è¯•å®Œæˆ - ${summary.status} (${summary.success_rate})`;
                document.getElementById('connection-status').className =
                    `status ${successRate >= 90 ? 'connected' : 'disconnected'}`;

                log(`å…¨é¢æµ‹è¯•å®Œæˆ: ${summary.status}, æˆåŠŸç‡: ${summary.success_rate}`);

            } finally {
                window.testState.isRunning = false;
                updateProgress(100);
            }
        };

        window.runCriticalTests = async function() {
            if (window.testState.isRunning) {
                alert('æµ‹è¯•æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
                return;
            }

            window.testState.isRunning = true;
            window.testState.startTime = Date.now();
            window.testState.totalTests = 0;
            window.testState.passedTests = 0;
            window.testState.failedTests = 0;
            window.testState.results = [];

            document.getElementById('connection-status').textContent = 'çŠ¶æ€: æ­£åœ¨è¿è¡Œå…³é”®æµ‹è¯•...';
            document.getElementById('connection-status').className = 'status testing';

            const criticalTests = [
                { name: 'æ•°æ®åº“è¿æ¥æµ‹è¯•', func: testDatabaseConnection },
                { name: 'é¡µé¢CRUDæµ‹è¯•', func: testPageCRUD },
                { name: 'å—CRUDæµ‹è¯•', func: testBlockCRUD },
                { name: 'åº”ç”¨å¯åŠ¨æµ‹è¯•', func: testAppStartup },
                { name: 'ç¼–è¾‘å™¨åŠŸèƒ½æµ‹è¯•', func: testEditorFunctions },
                { name: 'æ•°æ®å®Œæ•´æ€§æµ‹è¯•', func: testDataIntegrity }
            ];

            try {
                for (let i = 0; i < criticalTests.length; i++) {
                    const test = criticalTests[i];
                    const progress = ((i + 1) / criticalTests.length) * 100;
                    updateProgress(progress);

                    try {
                        await test.func();
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (error) {
                        console.error(`å…³é”®æµ‹è¯•å¤±è´¥: ${test.name}`, error);
                    }
                }

                const duration = (Date.now() - window.testState.startTime) / 1000;
                const successRate = (window.testState.passedTests / window.testState.totalTests) * 100;

                const summary = {
                    test_type: 'å…³é”®åŠŸèƒ½æµ‹è¯•',
                    total_tests: window.testState.totalTests,
                    passed_tests: window.testState.passedTests,
                    failed_tests: window.testState.failedTests,
                    success_rate: successRate.toFixed(1) + '%',
                    duration: duration.toFixed(2) + 'ç§’',
                    status: successRate >= 95 ? 'å…³é”®åŠŸèƒ½æ­£å¸¸' : 'å…³é”®åŠŸèƒ½å¼‚å¸¸',
                    timestamp: new Date().toISOString()
                };

                showResult('test-summary', summary, successRate < 95);

                document.getElementById('connection-status').textContent =
                    `çŠ¶æ€: å…³é”®æµ‹è¯•å®Œæˆ - ${summary.status}`;
                document.getElementById('connection-status').className =
                    `status ${successRate >= 95 ? 'connected' : 'disconnected'}`;

            } finally {
                window.testState.isRunning = false;
                updateProgress(100);
            }
        };

        window.stopAllTests = function() {
            if (window.testState.isRunning) {
                window.testState.isRunning = false;
                document.getElementById('connection-status').textContent = 'çŠ¶æ€: æµ‹è¯•å·²åœæ­¢';
                document.getElementById('connection-status').className = 'status disconnected';
                updateProgress(0);
                log('æµ‹è¯•å·²è¢«ç”¨æˆ·åœæ­¢');
            } else {
                alert('å½“å‰æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æµ‹è¯•');
            }
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥
        checkConnection();
    </script>
</body>
</html>
