<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebDAV åŒæ­¥åŠŸèƒ½æ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.danger {
            background: #dc3545;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.syncing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .result.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .result.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
        .sync-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .sync-info h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebDAV åŒæ­¥åŠŸèƒ½æ¼”ç¤º</h1>
        
        <div id="connection-status" class="status disconnected">
            è¿æ¥çŠ¶æ€: æ£€æŸ¥ä¸­...
        </div>
        
        <div class="sync-info">
            <h4>ğŸ”„ WebDAV åŒæ­¥åŠŸèƒ½è¯´æ˜</h4>
            <p>WebDAVåŒæ­¥åŠŸèƒ½å…è®¸æ‚¨å°†MingLogæ•°æ®ä¸äº‘å­˜å‚¨æœåŠ¡ï¼ˆå¦‚åšæœäº‘ã€NextCloudç­‰ï¼‰åŒæ­¥ã€‚è¿™æ˜¯ä¸€ä¸ªé¢„ç•™æ¥å£æ¼”ç¤ºï¼Œå±•ç¤ºäº†å®Œæ•´çš„åŒæ­¥æ¶æ„è®¾è®¡ã€‚</p>
            <p><strong>æ”¯æŒçš„åŠŸèƒ½ï¼š</strong>é…ç½®ç®¡ç†ã€è¿æ¥æµ‹è¯•ã€åŒå‘åŒæ­¥ã€å†²çªè§£å†³ã€çŠ¶æ€ç›‘æ§</p>
        </div>
        
        <div class="grid">
            <div class="section">
                <h3>WebDAV é…ç½®</h3>
                <div class="form-group">
                    <label for="server-url">æœåŠ¡å™¨åœ°å€</label>
                    <input type="url" id="server-url" placeholder="https://dav.jianguoyun.com/dav/" value="https://dav.jianguoyun.com/dav/">
                </div>
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="your@email.com" value="demo@example.com">
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="åº”ç”¨å¯†ç " value="demo-password">
                </div>
                <div class="form-group">
                    <label for="remote-path">è¿œç¨‹è·¯å¾„</label>
                    <input type="text" id="remote-path" placeholder="/minglog/" value="/minglog/">
                </div>
                <div class="form-group">
                    <label for="auto-sync">è‡ªåŠ¨åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="auto-sync" placeholder="300" value="300" min="60">
                </div>
                <button onclick="saveWebDAVConfig()">ä¿å­˜é…ç½®</button>
                <button onclick="loadWebDAVConfig()" class="warning">åŠ è½½é…ç½®</button>
                <div id="config-result" class="result"></div>
            </div>
            
            <div class="section">
                <h3>è¿æ¥æµ‹è¯•</h3>
                <p>æµ‹è¯•ä¸WebDAVæœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€</p>
                <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                <div id="connection-result" class="result"></div>
            </div>
        </div>
        
        <div class="section">
            <h3>åŒæ­¥æ“ä½œ</h3>
            <div class="grid">
                <div>
                    <h4>åŒæ­¥æ–¹å‘</h4>
                    <button onclick="startSync('Upload')" class="success">ä¸Šä¼ åˆ°äº‘ç«¯</button>
                    <button onclick="startSync('Download')" class="success">ä»äº‘ç«¯ä¸‹è½½</button>
                    <button onclick="startSync('Bidirectional')" class="success">åŒå‘åŒæ­¥</button>
                    <button onclick="stopSync()" class="danger">åœæ­¢åŒæ­¥</button>
                </div>
                <div>
                    <h4>åŒæ­¥çŠ¶æ€</h4>
                    <div id="sync-status" class="status disconnected">çŠ¶æ€: æœªçŸ¥</div>
                    <button onclick="getSyncStatus()">åˆ·æ–°çŠ¶æ€</button>
                </div>
            </div>
            
            <div class="progress">
                <div id="sync-progress" class="progress-bar" style="width: 0%"></div>
            </div>
            
            <div id="sync-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>å†²çªç®¡ç†</h3>
            <p>æŸ¥çœ‹å’Œè§£å†³åŒæ­¥å†²çª</p>
            <button onclick="getConflicts()">æ£€æŸ¥å†²çª</button>
            <button onclick="simulateConflict()" class="warning">æ¨¡æ‹Ÿå†²çª</button>
            <div id="conflicts-result" class="result"></div>
        </div>
        
        <div class="section">
            <h3>å®Œæ•´åŒæ­¥æµ‹è¯•</h3>
            <button onclick="runFullSyncTest()" class="success" style="font-size: 16px; padding: 12px 24px;">è¿è¡Œå®Œæ•´åŒæ­¥æµ‹è¯•</button>
            <div id="full-sync-result" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { invoke } from '@tauri-apps/api/core';
        
        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                await invoke('get_app_info');
                document.getElementById('connection-status').textContent = 'è¿æ¥çŠ¶æ€: å·²è¿æ¥åˆ°MingLog';
                document.getElementById('connection-status').className = 'status connected';
                return true;
            } catch (error) {
                document.getElementById('connection-status').textContent = 'è¿æ¥çŠ¶æ€: æœªè¿æ¥ - ' + error.toString();
                document.getElementById('connection-status').className = 'status disconnected';
                return false;
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        function showError(elementId, error) {
            showResult(elementId, { error: error.toString() }, true);
        }
        
        function log(message) {
            console.log(`[${new Date().toISOString()}] ${message}`);
        }
        
        function updateSyncProgress(percent) {
            document.getElementById('sync-progress').style.width = percent + '%';
        }
        
        // WebDAVé…ç½®å‡½æ•°
        window.saveWebDAVConfig = async function() {
            try {
                const config = {
                    server_url: document.getElementById('server-url').value,
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                    remote_path: document.getElementById('remote-path').value,
                    enabled: true,
                    auto_sync_interval: parseInt(document.getElementById('auto-sync').value) || null
                };
                
                await invoke('configure_webdav_sync', { config });
                
                showResult('config-result', {
                    message: 'WebDAVé…ç½®ä¿å­˜æˆåŠŸ',
                    config: { ...config, password: '***' }, // éšè—å¯†ç 
                    timestamp: new Date().toISOString()
                });
                
                log('WebDAVé…ç½®ä¿å­˜æˆåŠŸ');
            } catch (error) {
                log('WebDAVé…ç½®ä¿å­˜å¤±è´¥: ' + error.toString());
                showError('config-result', error);
            }
        };
        
        window.loadWebDAVConfig = async function() {
            try {
                const config = await invoke('get_webdav_config');
                
                if (config) {
                    document.getElementById('server-url').value = config.server_url || '';
                    document.getElementById('username').value = config.username || '';
                    document.getElementById('remote-path').value = config.remote_path || '';
                    document.getElementById('auto-sync').value = config.auto_sync_interval || 300;
                    
                    showResult('config-result', {
                        message: 'WebDAVé…ç½®åŠ è½½æˆåŠŸ',
                        config: { ...config, password: '***' },
                        timestamp: new Date().toISOString()
                    });
                } else {
                    showResult('config-result', {
                        message: 'æœªæ‰¾åˆ°WebDAVé…ç½®',
                        timestamp: new Date().toISOString()
                    }, true);
                }
                
                log('WebDAVé…ç½®åŠ è½½å®Œæˆ');
            } catch (error) {
                log('WebDAVé…ç½®åŠ è½½å¤±è´¥: ' + error.toString());
                showError('config-result', error);
            }
        };
        
        // è¿æ¥æµ‹è¯•å‡½æ•°
        window.testConnection = async function() {
            try {
                log('å¼€å§‹æµ‹è¯•WebDAVè¿æ¥');

                const isConnected = await invoke('test_webdav_connection');

                showResult('connection-result', {
                    message: isConnected ? 'WebDAVè¿æ¥æµ‹è¯•æˆåŠŸ' : 'WebDAVè¿æ¥æµ‹è¯•å¤±è´¥',
                    connected: isConnected,
                    timestamp: new Date().toISOString()
                }, !isConnected);

                log(`WebDAVè¿æ¥æµ‹è¯•${isConnected ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
            } catch (error) {
                log('WebDAVè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.toString());
                showError('connection-result', error);
            }
        };

        // åŒæ­¥æ“ä½œå‡½æ•°
        window.startSync = async function(direction) {
            try {
                log(`å¼€å§‹${direction}åŒæ­¥`);

                // æ›´æ–°çŠ¶æ€
                document.getElementById('sync-status').textContent = 'çŠ¶æ€: åŒæ­¥ä¸­...';
                document.getElementById('sync-status').className = 'status syncing';
                updateSyncProgress(0);

                // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
                const progressInterval = setInterval(() => {
                    const currentWidth = parseFloat(document.getElementById('sync-progress').style.width) || 0;
                    if (currentWidth < 90) {
                        updateSyncProgress(currentWidth + 10);
                    }
                }, 200);

                const result = await invoke('start_webdav_sync', { direction });

                clearInterval(progressInterval);
                updateSyncProgress(100);

                // æ›´æ–°çŠ¶æ€
                document.getElementById('sync-status').textContent = `çŠ¶æ€: ${result.status}`;
                document.getElementById('sync-status').className = `status ${result.status === 'Success' ? 'connected' : 'disconnected'}`;

                showResult('sync-result', {
                    message: `${direction}åŒæ­¥å®Œæˆ`,
                    result: result,
                    timestamp: new Date().toISOString()
                });

                log(`${direction}åŒæ­¥å®Œæˆ: ${result.status}`);
            } catch (error) {
                log(`${direction}åŒæ­¥å¤±è´¥: ` + error.toString());
                showError('sync-result', error);

                document.getElementById('sync-status').textContent = 'çŠ¶æ€: åŒæ­¥å¤±è´¥';
                document.getElementById('sync-status').className = 'status disconnected';
            }
        };

        window.stopSync = async function() {
            try {
                await invoke('stop_webdav_sync');

                document.getElementById('sync-status').textContent = 'çŠ¶æ€: å·²åœæ­¢';
                document.getElementById('sync-status').className = 'status disconnected';
                updateSyncProgress(0);

                showResult('sync-result', {
                    message: 'åŒæ­¥å·²åœæ­¢',
                    timestamp: new Date().toISOString()
                });

                log('åŒæ­¥å·²åœæ­¢');
            } catch (error) {
                log('åœæ­¢åŒæ­¥å¤±è´¥: ' + error.toString());
                showError('sync-result', error);
            }
        };

        window.getSyncStatus = async function() {
            try {
                const status = await invoke('get_sync_status');

                document.getElementById('sync-status').textContent = `çŠ¶æ€: ${status}`;
                document.getElementById('sync-status').className = `status ${status === 'Success' ? 'connected' : 'disconnected'}`;

                log(`å½“å‰åŒæ­¥çŠ¶æ€: ${status}`);
            } catch (error) {
                log('è·å–åŒæ­¥çŠ¶æ€å¤±è´¥: ' + error.toString());
                showError('sync-result', error);
            }
        };

        // å†²çªç®¡ç†å‡½æ•°
        window.getConflicts = async function() {
            try {
                const conflicts = await invoke('get_sync_conflicts');

                showResult('conflicts-result', {
                    message: conflicts.length > 0 ? `å‘ç° ${conflicts.length} ä¸ªå†²çª` : 'æ²¡æœ‰å‘ç°å†²çª',
                    conflicts: conflicts,
                    timestamp: new Date().toISOString()
                }, conflicts.length > 0);

                log(`å†²çªæ£€æŸ¥å®Œæˆ: ${conflicts.length} ä¸ªå†²çª`);
            } catch (error) {
                log('å†²çªæ£€æŸ¥å¤±è´¥: ' + error.toString());
                showError('conflicts-result', error);
            }
        };

        window.simulateConflict = async function() {
            showResult('conflicts-result', {
                message: 'æ¨¡æ‹Ÿå†²çªåœºæ™¯',
                simulated_conflicts: [
                    {
                        file_path: '/minglog/page1.md',
                        conflict_type: 'ContentConflict',
                        description: 'æœ¬åœ°å’Œè¿œç¨‹ç‰ˆæœ¬éƒ½æœ‰ä¿®æ”¹'
                    },
                    {
                        file_path: '/minglog/page2.md',
                        conflict_type: 'DeleteConflict',
                        description: 'æœ¬åœ°åˆ é™¤ï¼Œè¿œç¨‹ä¿®æ”¹'
                    }
                ],
                note: 'è¿™æ˜¯æ¼”ç¤ºæ•°æ®ï¼Œå®é™…å†²çªéœ€è¦çœŸå®çš„WebDAVæœåŠ¡å™¨',
                timestamp: new Date().toISOString()
            }, true);

            log('æ¨¡æ‹Ÿå†²çªåœºæ™¯å®Œæˆ');
        };

        // å®Œæ•´åŒæ­¥æµ‹è¯•
        window.runFullSyncTest = async function() {
            const startTime = Date.now();
            log('å¼€å§‹è¿è¡Œå®Œæ•´WebDAVåŒæ­¥æµ‹è¯•å¥—ä»¶');

            try {
                let results = [];

                // 1. é…ç½®æµ‹è¯•
                results.push('1. æµ‹è¯•WebDAVé…ç½®...');
                await saveWebDAVConfig();
                results.push('   âœ… é…ç½®ä¿å­˜æˆåŠŸ');

                await new Promise(resolve => setTimeout(resolve, 500));

                // 2. è¿æ¥æµ‹è¯•
                results.push('2. æµ‹è¯•WebDAVè¿æ¥...');
                await testConnection();
                results.push('   âœ… è¿æ¥æµ‹è¯•å®Œæˆ');

                await new Promise(resolve => setTimeout(resolve, 500));

                // 3. åŒæ­¥çŠ¶æ€æµ‹è¯•
                results.push('3. æµ‹è¯•åŒæ­¥çŠ¶æ€...');
                await getSyncStatus();
                results.push('   âœ… çŠ¶æ€è·å–æˆåŠŸ');

                await new Promise(resolve => setTimeout(resolve, 500));

                // 4. ä¸Šä¼ åŒæ­¥æµ‹è¯•
                results.push('4. æµ‹è¯•ä¸Šä¼ åŒæ­¥...');
                await startSync('Upload');
                results.push('   âœ… ä¸Šä¼ åŒæ­¥å®Œæˆ');

                await new Promise(resolve => setTimeout(resolve, 1000));

                // 5. å†²çªæ£€æŸ¥æµ‹è¯•
                results.push('5. æµ‹è¯•å†²çªæ£€æŸ¥...');
                await getConflicts();
                results.push('   âœ… å†²çªæ£€æŸ¥å®Œæˆ');

                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;

                results.push('');
                results.push(`ğŸ‰ å®Œæ•´WebDAVåŒæ­¥æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼`);
                results.push(`â±ï¸  æ€»è€—æ—¶: ${duration.toFixed(2)} ç§’`);
                results.push(`ğŸ“Š æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`);
                results.push('');
                results.push('ğŸ“ æ³¨æ„: è¿™æ˜¯WebDAVåŒæ­¥åŠŸèƒ½çš„é¢„ç•™æ¥å£æ¼”ç¤º');
                results.push('ğŸ”§ å®é™…çš„WebDAVå®¢æˆ·ç«¯å®ç°éœ€è¦é¢å¤–çš„HTTPåº“æ”¯æŒ');

                showResult('full-sync-result', {
                    status: 'WebDAVåŒæ­¥æµ‹è¯•å¥—ä»¶æ‰§è¡ŒæˆåŠŸ',
                    duration: `${duration.toFixed(2)} ç§’`,
                    results: results,
                    timestamp: new Date().toISOString()
                });

                log(`å®Œæ•´WebDAVåŒæ­¥æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶ ${duration.toFixed(2)} ç§’`);

            } catch (error) {
                showError('full-sync-result', error);
                log('WebDAVåŒæ­¥æµ‹è¯•å¥—ä»¶æ‰§è¡Œå¤±è´¥: ' + error.toString());
            }
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥
        checkConnection();
    </script>
</body>
</html>
