<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据持久化验证</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .test-step h3 {
            margin-top: 0;
            color: #495057;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .result.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .result.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MingLog 数据持久化验证</h1>
        
        <div id="overall-status" class="status info">
            准备开始验证...
        </div>
        
        <div class="test-step">
            <h3>步骤 1: 初始化数据库</h3>
            <button onclick="step1_initDatabase()">初始化数据库</button>
            <div id="step1-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>步骤 2: 创建测试页面</h3>
            <button onclick="step2_createPage()" id="step2-btn" disabled>创建页面</button>
            <div id="step2-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>步骤 3: 创建测试块</h3>
            <button onclick="step3_createBlock()" id="step3-btn" disabled>创建块</button>
            <div id="step3-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>步骤 4: 验证数据读取</h3>
            <button onclick="step4_verifyData()" id="step4-btn" disabled>验证数据</button>
            <div id="step4-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>步骤 5: 更新数据</h3>
            <button onclick="step5_updateData()" id="step5-btn" disabled>更新数据</button>
            <div id="step5-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>步骤 6: 验证持久化</h3>
            <button onclick="step6_verifyPersistence()" id="step6-btn" disabled>验证持久化</button>
            <div id="step6-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>完整验证</h3>
            <button onclick="runFullVerification()" style="background: #28a745; font-size: 16px; padding: 12px 24px;">运行完整验证</button>
            <div id="full-result" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { invoke } from '@tauri-apps/api/core';
        
        // 全局测试数据
        window.testData = {
            pageId: null,
            blockId: null,
            timestamp: Date.now()
        };
        
        // 辅助函数
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        function showError(elementId, error) {
            showResult(elementId, { error: error.toString() }, true);
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('overall-status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function enableButton(buttonId) {
            document.getElementById(buttonId).disabled = false;
        }
        
        // 步骤 1: 初始化数据库
        window.step1_initDatabase = async function() {
            try {
                updateStatus('正在初始化数据库...', 'info');
                
                const result = await invoke('init_database');
                showResult('step1-result', { 
                    message: result,
                    timestamp: new Date().toISOString()
                });
                
                updateStatus('数据库初始化成功', 'success');
                enableButton('step2-btn');
                
            } catch (error) {
                showError('step1-result', error);
                updateStatus('数据库初始化失败', 'error');
            }
        };
        
        // 步骤 2: 创建测试页面
        window.step2_createPage = async function() {
            try {
                updateStatus('正在创建测试页面...', 'info');
                
                const request = {
                    graph_id: 'default',
                    name: `持久化测试页面_${window.testData.timestamp}`,
                    title: '数据持久化验证页面',
                    tags: JSON.stringify(['持久化', '验证', '测试']),
                    is_journal: false
                };
                
                const result = await invoke('create_page', { request });
                window.testData.pageId = result.id;
                
                showResult('step2-result', result);
                updateStatus('测试页面创建成功', 'success');
                enableButton('step3-btn');
                
            } catch (error) {
                showError('step2-result', error);
                updateStatus('页面创建失败', 'error');
            }
        };
        
        // 步骤 3: 创建测试块
        window.step3_createBlock = async function() {
            if (!window.testData.pageId) {
                showError('step3-result', '请先创建页面');
                return;
            }
            
            try {
                updateStatus('正在创建测试块...', 'info');
                
                const request = {
                    graph_id: 'default',
                    page_id: window.testData.pageId,
                    content: `这是一个数据持久化测试块。\n创建时间: ${new Date().toLocaleString('zh-CN')}\n时间戳: ${window.testData.timestamp}`,
                    order: 0
                };
                
                const result = await invoke('create_block', { request });
                window.testData.blockId = result.id;
                
                showResult('step3-result', result);
                updateStatus('测试块创建成功', 'success');
                enableButton('step4-btn');
                
            } catch (error) {
                showError('step3-result', error);
                updateStatus('块创建失败', 'error');
            }
        };
        
        // 步骤 4: 验证数据读取
        window.step4_verifyData = async function() {
            try {
                updateStatus('正在验证数据读取...', 'info');
                
                // 读取页面
                const page = await invoke('get_page', { id: window.testData.pageId });
                
                // 读取块
                const blocks = await invoke('get_blocks_by_page', { pageId: window.testData.pageId });
                
                // 读取所有页面
                const allPages = await invoke('get_pages_by_graph', { graphId: 'default' });
                
                const verification = {
                    page: page,
                    blocks: blocks,
                    totalPages: allPages.length,
                    dataIntegrity: {
                        pageExists: !!page,
                        blockExists: blocks.length > 0,
                        pageIdMatches: blocks.length > 0 && blocks[0].page_id === window.testData.pageId,
                        graphIdMatches: page.graph_id === 'default'
                    }
                };
                
                showResult('step4-result', verification);
                
                if (verification.dataIntegrity.pageExists && verification.dataIntegrity.blockExists) {
                    updateStatus('数据读取验证成功', 'success');
                    enableButton('step5-btn');
                } else {
                    updateStatus('数据读取验证失败', 'error');
                }
                
            } catch (error) {
                showError('step4-result', error);
                updateStatus('数据读取验证失败', 'error');
            }
        };
        
        // 步骤 5: 更新数据
        window.step5_updateData = async function() {
            try {
                updateStatus('正在更新数据...', 'info');
                
                // 更新页面
                const pageUpdateRequest = {
                    id: window.testData.pageId,
                    title: '更新后的数据持久化验证页面'
                };
                const updatedPage = await invoke('update_page', { request: pageUpdateRequest });
                
                // 更新块
                const blockUpdateRequest = {
                    id: window.testData.blockId,
                    content: `这是一个更新后的数据持久化测试块。\n更新时间: ${new Date().toLocaleString('zh-CN')}\n原始时间戳: ${window.testData.timestamp}`
                };
                const updatedBlock = await invoke('update_block', { request: blockUpdateRequest });
                
                showResult('step5-result', {
                    updatedPage: updatedPage,
                    updatedBlock: updatedBlock
                });
                
                updateStatus('数据更新成功', 'success');
                enableButton('step6-btn');
                
            } catch (error) {
                showError('step5-result', error);
                updateStatus('数据更新失败', 'error');
            }
        };
        
        // 步骤 6: 验证持久化
        window.step6_verifyPersistence = async function() {
            try {
                updateStatus('正在验证数据持久化...', 'info');
                
                // 重新读取数据以验证更新是否持久化
                const page = await invoke('get_page', { id: window.testData.pageId });
                const blocks = await invoke('get_blocks_by_page', { pageId: window.testData.pageId });
                
                const persistenceCheck = {
                    pageTitle: page.title,
                    blockContent: blocks[0]?.content,
                    pageUpdatedAt: page.updated_at,
                    blockUpdatedAt: blocks[0]?.updated_at,
                    isPersistent: {
                        pageTitle: page.title === '更新后的数据持久化验证页面',
                        blockContent: blocks[0]?.content.includes('更新后的'),
                        timestampsUpdated: true // 简化检查
                    }
                };
                
                showResult('step6-result', persistenceCheck);
                
                const allPersistent = Object.values(persistenceCheck.isPersistent).every(v => v);
                if (allPersistent) {
                    updateStatus('🎉 数据持久化验证完全成功！', 'success');
                } else {
                    updateStatus('数据持久化验证部分失败', 'error');
                }
                
            } catch (error) {
                showError('step6-result', error);
                updateStatus('数据持久化验证失败', 'error');
            }
        };
        
        // 运行完整验证
        window.runFullVerification = async function() {
            const startTime = Date.now();
            updateStatus('开始完整验证流程...', 'info');
            
            try {
                await step1_initDatabase();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step2_createPage();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step3_createBlock();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step4_verifyData();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step5_updateData();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step6_verifyPersistence();
                
                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;
                
                showResult('full-result', {
                    status: '完整验证流程执行完成',
                    duration: `${duration.toFixed(2)} 秒`,
                    testData: window.testData,
                    timestamp: new Date().toISOString()
                });
                
                updateStatus(`🎉 完整验证流程完成！耗时 ${duration.toFixed(2)} 秒`, 'success');
                
            } catch (error) {
                showError('full-result', error);
                updateStatus('完整验证流程失败', 'error');
            }
        };
    </script>
</body>
</html>
