<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æŒä¹…åŒ–éªŒè¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .test-step h3 {
            margin-top: 0;
            color: #495057;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .result.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .result.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MingLog æ•°æ®æŒä¹…åŒ–éªŒè¯</h1>
        
        <div id="overall-status" class="status info">
            å‡†å¤‡å¼€å§‹éªŒè¯...
        </div>
        
        <div class="test-step">
            <h3>æ­¥éª¤ 1: åˆå§‹åŒ–æ•°æ®åº“</h3>
            <button onclick="step1_initDatabase()">åˆå§‹åŒ–æ•°æ®åº“</button>
            <div id="step1-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>æ­¥éª¤ 2: åˆ›å»ºæµ‹è¯•é¡µé¢</h3>
            <button onclick="step2_createPage()" id="step2-btn" disabled>åˆ›å»ºé¡µé¢</button>
            <div id="step2-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>æ­¥éª¤ 3: åˆ›å»ºæµ‹è¯•å—</h3>
            <button onclick="step3_createBlock()" id="step3-btn" disabled>åˆ›å»ºå—</button>
            <div id="step3-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>æ­¥éª¤ 4: éªŒè¯æ•°æ®è¯»å–</h3>
            <button onclick="step4_verifyData()" id="step4-btn" disabled>éªŒè¯æ•°æ®</button>
            <div id="step4-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>æ­¥éª¤ 5: æ›´æ–°æ•°æ®</h3>
            <button onclick="step5_updateData()" id="step5-btn" disabled>æ›´æ–°æ•°æ®</button>
            <div id="step5-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>æ­¥éª¤ 6: éªŒè¯æŒä¹…åŒ–</h3>
            <button onclick="step6_verifyPersistence()" id="step6-btn" disabled>éªŒè¯æŒä¹…åŒ–</button>
            <div id="step6-result" class="result"></div>
        </div>
        
        <div class="test-step">
            <h3>å®Œæ•´éªŒè¯</h3>
            <button onclick="runFullVerification()" style="background: #28a745; font-size: 16px; padding: 12px 24px;">è¿è¡Œå®Œæ•´éªŒè¯</button>
            <div id="full-result" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { invoke } from '@tauri-apps/api/core';
        
        // å…¨å±€æµ‹è¯•æ•°æ®
        window.testData = {
            pageId: null,
            blockId: null,
            timestamp: Date.now()
        };
        
        // è¾…åŠ©å‡½æ•°
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        function showError(elementId, error) {
            showResult(elementId, { error: error.toString() }, true);
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('overall-status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function enableButton(buttonId) {
            document.getElementById(buttonId).disabled = false;
        }
        
        // æ­¥éª¤ 1: åˆå§‹åŒ–æ•°æ®åº“
        window.step1_initDatabase = async function() {
            try {
                updateStatus('æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...', 'info');
                
                const result = await invoke('init_database');
                showResult('step1-result', { 
                    message: result,
                    timestamp: new Date().toISOString()
                });
                
                updateStatus('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ', 'success');
                enableButton('step2-btn');
                
            } catch (error) {
                showError('step1-result', error);
                updateStatus('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        };
        
        // æ­¥éª¤ 2: åˆ›å»ºæµ‹è¯•é¡µé¢
        window.step2_createPage = async function() {
            try {
                updateStatus('æ­£åœ¨åˆ›å»ºæµ‹è¯•é¡µé¢...', 'info');
                
                const request = {
                    graph_id: 'default',
                    name: `æŒä¹…åŒ–æµ‹è¯•é¡µé¢_${window.testData.timestamp}`,
                    title: 'æ•°æ®æŒä¹…åŒ–éªŒè¯é¡µé¢',
                    tags: JSON.stringify(['æŒä¹…åŒ–', 'éªŒè¯', 'æµ‹è¯•']),
                    is_journal: false
                };
                
                const result = await invoke('create_page', { request });
                window.testData.pageId = result.id;
                
                showResult('step2-result', result);
                updateStatus('æµ‹è¯•é¡µé¢åˆ›å»ºæˆåŠŸ', 'success');
                enableButton('step3-btn');
                
            } catch (error) {
                showError('step2-result', error);
                updateStatus('é¡µé¢åˆ›å»ºå¤±è´¥', 'error');
            }
        };
        
        // æ­¥éª¤ 3: åˆ›å»ºæµ‹è¯•å—
        window.step3_createBlock = async function() {
            if (!window.testData.pageId) {
                showError('step3-result', 'è¯·å…ˆåˆ›å»ºé¡µé¢');
                return;
            }
            
            try {
                updateStatus('æ­£åœ¨åˆ›å»ºæµ‹è¯•å—...', 'info');
                
                const request = {
                    graph_id: 'default',
                    page_id: window.testData.pageId,
                    content: `è¿™æ˜¯ä¸€ä¸ªæ•°æ®æŒä¹…åŒ–æµ‹è¯•å—ã€‚\nåˆ›å»ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\næ—¶é—´æˆ³: ${window.testData.timestamp}`,
                    order: 0
                };
                
                const result = await invoke('create_block', { request });
                window.testData.blockId = result.id;
                
                showResult('step3-result', result);
                updateStatus('æµ‹è¯•å—åˆ›å»ºæˆåŠŸ', 'success');
                enableButton('step4-btn');
                
            } catch (error) {
                showError('step3-result', error);
                updateStatus('å—åˆ›å»ºå¤±è´¥', 'error');
            }
        };
        
        // æ­¥éª¤ 4: éªŒè¯æ•°æ®è¯»å–
        window.step4_verifyData = async function() {
            try {
                updateStatus('æ­£åœ¨éªŒè¯æ•°æ®è¯»å–...', 'info');
                
                // è¯»å–é¡µé¢
                const page = await invoke('get_page', { id: window.testData.pageId });
                
                // è¯»å–å—
                const blocks = await invoke('get_blocks_by_page', { pageId: window.testData.pageId });
                
                // è¯»å–æ‰€æœ‰é¡µé¢
                const allPages = await invoke('get_pages_by_graph', { graphId: 'default' });
                
                const verification = {
                    page: page,
                    blocks: blocks,
                    totalPages: allPages.length,
                    dataIntegrity: {
                        pageExists: !!page,
                        blockExists: blocks.length > 0,
                        pageIdMatches: blocks.length > 0 && blocks[0].page_id === window.testData.pageId,
                        graphIdMatches: page.graph_id === 'default'
                    }
                };
                
                showResult('step4-result', verification);
                
                if (verification.dataIntegrity.pageExists && verification.dataIntegrity.blockExists) {
                    updateStatus('æ•°æ®è¯»å–éªŒè¯æˆåŠŸ', 'success');
                    enableButton('step5-btn');
                } else {
                    updateStatus('æ•°æ®è¯»å–éªŒè¯å¤±è´¥', 'error');
                }
                
            } catch (error) {
                showError('step4-result', error);
                updateStatus('æ•°æ®è¯»å–éªŒè¯å¤±è´¥', 'error');
            }
        };
        
        // æ­¥éª¤ 5: æ›´æ–°æ•°æ®
        window.step5_updateData = async function() {
            try {
                updateStatus('æ­£åœ¨æ›´æ–°æ•°æ®...', 'info');
                
                // æ›´æ–°é¡µé¢
                const pageUpdateRequest = {
                    id: window.testData.pageId,
                    title: 'æ›´æ–°åçš„æ•°æ®æŒä¹…åŒ–éªŒè¯é¡µé¢'
                };
                const updatedPage = await invoke('update_page', { request: pageUpdateRequest });
                
                // æ›´æ–°å—
                const blockUpdateRequest = {
                    id: window.testData.blockId,
                    content: `è¿™æ˜¯ä¸€ä¸ªæ›´æ–°åçš„æ•°æ®æŒä¹…åŒ–æµ‹è¯•å—ã€‚\næ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}\nåŸå§‹æ—¶é—´æˆ³: ${window.testData.timestamp}`
                };
                const updatedBlock = await invoke('update_block', { request: blockUpdateRequest });
                
                showResult('step5-result', {
                    updatedPage: updatedPage,
                    updatedBlock: updatedBlock
                });
                
                updateStatus('æ•°æ®æ›´æ–°æˆåŠŸ', 'success');
                enableButton('step6-btn');
                
            } catch (error) {
                showError('step5-result', error);
                updateStatus('æ•°æ®æ›´æ–°å¤±è´¥', 'error');
            }
        };
        
        // æ­¥éª¤ 6: éªŒè¯æŒä¹…åŒ–
        window.step6_verifyPersistence = async function() {
            try {
                updateStatus('æ­£åœ¨éªŒè¯æ•°æ®æŒä¹…åŒ–...', 'info');
                
                // é‡æ–°è¯»å–æ•°æ®ä»¥éªŒè¯æ›´æ–°æ˜¯å¦æŒä¹…åŒ–
                const page = await invoke('get_page', { id: window.testData.pageId });
                const blocks = await invoke('get_blocks_by_page', { pageId: window.testData.pageId });
                
                const persistenceCheck = {
                    pageTitle: page.title,
                    blockContent: blocks[0]?.content,
                    pageUpdatedAt: page.updated_at,
                    blockUpdatedAt: blocks[0]?.updated_at,
                    isPersistent: {
                        pageTitle: page.title === 'æ›´æ–°åçš„æ•°æ®æŒä¹…åŒ–éªŒè¯é¡µé¢',
                        blockContent: blocks[0]?.content.includes('æ›´æ–°åçš„'),
                        timestampsUpdated: true // ç®€åŒ–æ£€æŸ¥
                    }
                };
                
                showResult('step6-result', persistenceCheck);
                
                const allPersistent = Object.values(persistenceCheck.isPersistent).every(v => v);
                if (allPersistent) {
                    updateStatus('ğŸ‰ æ•°æ®æŒä¹…åŒ–éªŒè¯å®Œå…¨æˆåŠŸï¼', 'success');
                } else {
                    updateStatus('æ•°æ®æŒä¹…åŒ–éªŒè¯éƒ¨åˆ†å¤±è´¥', 'error');
                }
                
            } catch (error) {
                showError('step6-result', error);
                updateStatus('æ•°æ®æŒä¹…åŒ–éªŒè¯å¤±è´¥', 'error');
            }
        };
        
        // è¿è¡Œå®Œæ•´éªŒè¯
        window.runFullVerification = async function() {
            const startTime = Date.now();
            updateStatus('å¼€å§‹å®Œæ•´éªŒè¯æµç¨‹...', 'info');
            
            try {
                await step1_initDatabase();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step2_createPage();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step3_createBlock();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step4_verifyData();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step5_updateData();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await step6_verifyPersistence();
                
                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;
                
                showResult('full-result', {
                    status: 'å®Œæ•´éªŒè¯æµç¨‹æ‰§è¡Œå®Œæˆ',
                    duration: `${duration.toFixed(2)} ç§’`,
                    testData: window.testData,
                    timestamp: new Date().toISOString()
                });
                
                updateStatus(`ğŸ‰ å®Œæ•´éªŒè¯æµç¨‹å®Œæˆï¼è€—æ—¶ ${duration.toFixed(2)} ç§’`, 'success');
                
            } catch (error) {
                showError('full-result', error);
                updateStatus('å®Œæ•´éªŒè¯æµç¨‹å¤±è´¥', 'error');
            }
        };
    </script>
</body>
</html>
