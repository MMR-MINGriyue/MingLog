<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MingLog æ•°æ®æŒä¹…åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.danger {
            background: #dc3545;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .result.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .result.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .stats {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .stats h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MingLog æ•°æ®æŒä¹…åŒ–æµ‹è¯•</h1>
        
        <div id="connection-status" class="status disconnected">
            è¿æ¥çŠ¶æ€: æ£€æŸ¥ä¸­...
        </div>
        
        <div class="stats">
            <h4>æ•°æ®åº“ç»Ÿè®¡</h4>
            <div id="stats-content">æ­£åœ¨åŠ è½½...</div>
        </div>
        
        <div class="test-grid">
            <div class="test-section">
                <h3>æ•°æ®åº“åˆå§‹åŒ–</h3>
                <button onclick="testInitDatabase()">åˆå§‹åŒ–æ•°æ®åº“</button>
                <button onclick="testGetAppInfo()">è·å–åº”ç”¨ä¿¡æ¯</button>
                <div id="init-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>é¡µé¢CRUDæ“ä½œ</h3>
                <button onclick="testCreatePage()">åˆ›å»ºé¡µé¢</button>
                <button onclick="testGetPages()">è·å–é¡µé¢åˆ—è¡¨</button>
                <button onclick="testUpdatePage()">æ›´æ–°é¡µé¢</button>
                <button class="danger" onclick="testDeletePage()">åˆ é™¤é¡µé¢</button>
                <div id="page-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>å—CRUDæ“ä½œ</h3>
                <button onclick="testCreateBlock()">åˆ›å»ºå—</button>
                <button onclick="testGetBlocks()">è·å–å—åˆ—è¡¨</button>
                <button onclick="testUpdateBlock()">æ›´æ–°å—</button>
                <button class="danger" onclick="testDeleteBlock()">åˆ é™¤å—</button>
                <div id="block-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>æœç´¢åŠŸèƒ½</h3>
                <button onclick="testSearch()">æœç´¢æµ‹è¯•</button>
                <button onclick="testAdvancedSearch()">é«˜çº§æœç´¢</button>
                <div id="search-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>æ•°æ®å®Œæ•´æ€§</h3>
                <button onclick="testDataIntegrity()">æ£€æŸ¥æ•°æ®å®Œæ•´æ€§</button>
                <button onclick="testConcurrentOperations()">å¹¶å‘æ“ä½œæµ‹è¯•</button>
                <div id="integrity-result" class="result"></div>
            </div>
            
            <div class="test-section">
                <h3>æ‰¹é‡æ“ä½œ</h3>
                <button class="success" onclick="testCreateSampleData()">åˆ›å»ºç¤ºä¾‹æ•°æ®</button>
                <button onclick="testBatchOperations()">æ‰¹é‡æ“ä½œæµ‹è¯•</button>
                <button class="danger" onclick="testCleanupData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
                <div id="batch-result" class="result"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>å®Œæ•´æµ‹è¯•å¥—ä»¶</h3>
            <button class="success" onclick="runFullTestSuite()" style="font-size: 16px; padding: 12px 24px;">è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶</button>
            <div id="full-test-result" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { invoke } from '@tauri-apps/api/core';
        
        // å…¨å±€å˜é‡å­˜å‚¨æµ‹è¯•æ•°æ®
        window.testData = {
            pageId: null,
            blockId: null,
            graphId: 'default'
        };
        
        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                await invoke('get_app_info');
                document.getElementById('connection-status').textContent = 'è¿æ¥çŠ¶æ€: å·²è¿æ¥';
                document.getElementById('connection-status').className = 'status connected';
                await updateStats();
                return true;
            } catch (error) {
                document.getElementById('connection-status').textContent = 'è¿æ¥çŠ¶æ€: æœªè¿æ¥ - ' + error.toString();
                document.getElementById('connection-status').className = 'status disconnected';
                return false;
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            try {
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });
                const statsContent = document.getElementById('stats-content');
                statsContent.innerHTML = `
                    é¡µé¢æ•°é‡: ${pages.length}<br>
                    æ•°æ®åº“è·¯å¾„: æœ¬åœ°SQLiteæ•°æ®åº“<br>
                    æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}
                `;
            } catch (error) {
                document.getElementById('stats-content').textContent = 'æ— æ³•è·å–ç»Ÿè®¡ä¿¡æ¯: ' + error.toString();
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }
        
        function showError(elementId, error) {
            showResult(elementId, { error: error.toString() }, true);
        }
        
        function log(message) {
            console.log(`[${new Date().toISOString()}] ${message}`);
        }
        
        // æµ‹è¯•å‡½æ•°
        window.testInitDatabase = async function() {
            try {
                log('å¼€å§‹æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•');
                const result = await invoke('init_database');
                showResult('init-result', { message: result, timestamp: new Date().toISOString() });
                await updateStats();
                log('æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•å®Œæˆ');
            } catch (error) {
                log('æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•å¤±è´¥: ' + error.toString());
                showError('init-result', error);
            }
        };
        
        window.testGetAppInfo = async function() {
            try {
                const result = await invoke('get_app_info');
                showResult('init-result', result);
            } catch (error) {
                showError('init-result', error);
            }
        };
        
        window.testCreatePage = async function() {
            try {
                const timestamp = Date.now();
                const request = {
                    graph_id: 'default',
                    name: `æµ‹è¯•é¡µé¢_${timestamp}`,
                    title: `æµ‹è¯•é¡µé¢æ ‡é¢˜_${timestamp}`,
                    tags: JSON.stringify(['æµ‹è¯•', 'æŒä¹…åŒ–']),
                    is_journal: false
                };
                const result = await invoke('create_page', { request });
                window.testData.pageId = result.id;
                showResult('page-result', result);
                await updateStats();
                log(`åˆ›å»ºé¡µé¢æˆåŠŸ: ${result.id}`);
            } catch (error) {
                showError('page-result', error);
            }
        };
        
        window.testGetPages = async function() {
            try {
                const result = await invoke('get_pages_by_graph', { graphId: 'default' });
                showResult('page-result', { count: result.length, pages: result });
                log(`è·å–åˆ° ${result.length} ä¸ªé¡µé¢`);
            } catch (error) {
                showError('page-result', error);
            }
        };
        
        window.testUpdatePage = async function() {
            if (!window.testData.pageId) {
                showError('page-result', 'è¯·å…ˆåˆ›å»ºé¡µé¢');
                return;
            }
            
            try {
                const request = {
                    id: window.testData.pageId,
                    title: `æ›´æ–°çš„é¡µé¢æ ‡é¢˜_${Date.now()}`
                };
                const result = await invoke('update_page', { request });
                showResult('page-result', result);
                log(`æ›´æ–°é¡µé¢æˆåŠŸ: ${window.testData.pageId}`);
            } catch (error) {
                showError('page-result', error);
            }
        };
        
        window.testDeletePage = async function() {
            if (!window.testData.pageId) {
                showError('page-result', 'è¯·å…ˆåˆ›å»ºé¡µé¢');
                return;
            }
            
            try {
                await invoke('delete_page', { id: window.testData.pageId });
                showResult('page-result', { message: 'é¡µé¢åˆ é™¤æˆåŠŸ', deletedId: window.testData.pageId });
                window.testData.pageId = null;
                await updateStats();
                log('åˆ é™¤é¡µé¢æˆåŠŸ');
            } catch (error) {
                showError('page-result', error);
            }
        };
        
        window.testCreateBlock = async function() {
            if (!window.testData.pageId) {
                showError('block-result', 'è¯·å…ˆåˆ›å»ºé¡µé¢');
                return;
            }

            try {
                const request = {
                    graph_id: 'default',
                    page_id: window.testData.pageId,
                    content: `æµ‹è¯•å—å†…å®¹ - ${new Date().toLocaleString('zh-CN')}`,
                    order: 0
                };
                const result = await invoke('create_block', { request });
                window.testData.blockId = result.id;
                showResult('block-result', result);
                log(`åˆ›å»ºå—æˆåŠŸ: ${result.id}`);
            } catch (error) {
                showError('block-result', error);
            }
        };

        window.testGetBlocks = async function() {
            if (!window.testData.pageId) {
                showError('block-result', 'è¯·å…ˆåˆ›å»ºé¡µé¢');
                return;
            }

            try {
                const result = await invoke('get_blocks_by_page', { pageId: window.testData.pageId });
                showResult('block-result', { count: result.length, blocks: result });
                log(`è·å–åˆ° ${result.length} ä¸ªå—`);
            } catch (error) {
                showError('block-result', error);
            }
        };

        window.testUpdateBlock = async function() {
            if (!window.testData.blockId) {
                showError('block-result', 'è¯·å…ˆåˆ›å»ºå—');
                return;
            }

            try {
                const request = {
                    id: window.testData.blockId,
                    content: `æ›´æ–°çš„å—å†…å®¹ - ${new Date().toLocaleString('zh-CN')}`
                };
                const result = await invoke('update_block', { request });
                showResult('block-result', result);
                log(`æ›´æ–°å—æˆåŠŸ: ${window.testData.blockId}`);
            } catch (error) {
                showError('block-result', error);
            }
        };

        window.testDeleteBlock = async function() {
            if (!window.testData.blockId) {
                showError('block-result', 'è¯·å…ˆåˆ›å»ºå—');
                return;
            }

            try {
                await invoke('delete_block', { id: window.testData.blockId });
                showResult('block-result', { message: 'å—åˆ é™¤æˆåŠŸ', deletedId: window.testData.blockId });
                window.testData.blockId = null;
                log('åˆ é™¤å—æˆåŠŸ');
            } catch (error) {
                showError('block-result', error);
            }
        };

        window.testSearch = async function() {
            try {
                const request = {
                    query: 'æµ‹è¯•',
                    include_pages: true,
                    include_blocks: true,
                    limit: 10
                };
                const result = await invoke('search_blocks', { request });
                showResult('search-result', result);
                log(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${result.pages?.length || 0} ä¸ªé¡µé¢ï¼Œ${result.blocks?.length || 0} ä¸ªå—`);
            } catch (error) {
                showError('search-result', error);
            }
        };

        window.testAdvancedSearch = async function() {
            try {
                const request = {
                    query: 'æŒä¹…åŒ–',
                    include_pages: true,
                    include_blocks: true,
                    limit: 20
                };
                const result = await invoke('search_blocks', { request });
                showResult('search-result', {
                    query: 'æŒä¹…åŒ–',
                    results: result,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                showError('search-result', error);
            }
        };

        window.testDataIntegrity = async function() {
            try {
                log('å¼€å§‹æ•°æ®å®Œæ•´æ€§æ£€æŸ¥');
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });
                let totalBlocks = 0;
                let integrityIssues = [];

                for (const page of pages) {
                    try {
                        const blocks = await invoke('get_blocks_by_page', { pageId: page.id });
                        totalBlocks += blocks.length;

                        // æ£€æŸ¥æ¯ä¸ªå—æ˜¯å¦æœ‰æœ‰æ•ˆçš„page_id
                        for (const block of blocks) {
                            if (block.page_id !== page.id) {
                                integrityIssues.push(`å— ${block.id} çš„ page_id ä¸åŒ¹é…`);
                            }
                        }
                    } catch (error) {
                        integrityIssues.push(`æ— æ³•è·å–é¡µé¢ ${page.id} çš„å—: ${error.toString()}`);
                    }
                }

                const result = {
                    totalPages: pages.length,
                    totalBlocks: totalBlocks,
                    integrityIssues: integrityIssues,
                    status: integrityIssues.length === 0 ? 'æ•°æ®å®Œæ•´æ€§è‰¯å¥½' : 'å‘ç°å®Œæ•´æ€§é—®é¢˜',
                    timestamp: new Date().toISOString()
                };

                showResult('integrity-result', result);
                log(`æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ: ${pages.length} é¡µé¢, ${totalBlocks} å—, ${integrityIssues.length} é—®é¢˜`);
            } catch (error) {
                showError('integrity-result', error);
            }
        };

        window.testConcurrentOperations = async function() {
            try {
                log('å¼€å§‹å¹¶å‘æ“ä½œæµ‹è¯•');
                const promises = [];

                // å¹¶å‘åˆ›å»ºå¤šä¸ªé¡µé¢
                for (let i = 0; i < 5; i++) {
                    promises.push(invoke('create_page', {
                        request: {
                            graph_id: 'default',
                            name: `å¹¶å‘æµ‹è¯•é¡µé¢_${i}_${Date.now()}`,
                            title: `å¹¶å‘æµ‹è¯•é¡µé¢æ ‡é¢˜_${i}`,
                            tags: JSON.stringify(['å¹¶å‘', 'æµ‹è¯•']),
                            is_journal: false
                        }
                    }));
                }

                const results = await Promise.all(promises);
                showResult('integrity-result', {
                    message: 'å¹¶å‘æ“ä½œæµ‹è¯•å®Œæˆ',
                    createdPages: results.length,
                    pageIds: results.map(r => r.id),
                    timestamp: new Date().toISOString()
                });

                await updateStats();
                log(`å¹¶å‘æ“ä½œæµ‹è¯•å®Œæˆï¼Œåˆ›å»ºäº† ${results.length} ä¸ªé¡µé¢`);
            } catch (error) {
                showError('integrity-result', error);
            }
        };

        window.testCreateSampleData = async function() {
            try {
                await invoke('create_sample_graph_data');
                showResult('batch-result', {
                    message: 'ç¤ºä¾‹æ•°æ®åˆ›å»ºæˆåŠŸ',
                    timestamp: new Date().toISOString()
                });
                await updateStats();
                log('ç¤ºä¾‹æ•°æ®åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                showError('batch-result', error);
            }
        };

        window.testBatchOperations = async function() {
            try {
                log('å¼€å§‹æ‰¹é‡æ“ä½œæµ‹è¯•');

                // æ‰¹é‡åˆ›å»ºé¡µé¢
                const pagePromises = [];
                for (let i = 0; i < 3; i++) {
                    pagePromises.push(invoke('create_page', {
                        request: {
                            graph_id: 'default',
                            name: `æ‰¹é‡é¡µé¢_${i}_${Date.now()}`,
                            title: `æ‰¹é‡é¡µé¢æ ‡é¢˜_${i}`,
                            tags: JSON.stringify(['æ‰¹é‡', 'æµ‹è¯•']),
                            is_journal: false
                        }
                    }));
                }

                const pages = await Promise.all(pagePromises);

                // ä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºå—
                const blockPromises = [];
                pages.forEach((page, index) => {
                    for (let j = 0; j < 2; j++) {
                        blockPromises.push(invoke('create_block', {
                            request: {
                                graph_id: 'default',
                                page_id: page.id,
                                content: `æ‰¹é‡å—å†…å®¹ ${index}-${j} - ${new Date().toLocaleString('zh-CN')}`,
                                order: j
                            }
                        }));
                    }
                });

                const blocks = await Promise.all(blockPromises);

                showResult('batch-result', {
                    message: 'æ‰¹é‡æ“ä½œå®Œæˆ',
                    createdPages: pages.length,
                    createdBlocks: blocks.length,
                    timestamp: new Date().toISOString()
                });

                await updateStats();
                log(`æ‰¹é‡æ“ä½œå®Œæˆ: ${pages.length} é¡µé¢, ${blocks.length} å—`);
            } catch (error) {
                showError('batch-result', error);
            }
        };

        window.testCleanupData = async function() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰åŒ…å«"æµ‹è¯•"ã€"å¹¶å‘"ã€"æ‰¹é‡"çš„é¡µé¢ã€‚')) {
                return;
            }

            try {
                log('å¼€å§‹æ¸…ç†æµ‹è¯•æ•°æ®');
                const pages = await invoke('get_pages_by_graph', { graphId: 'default' });
                let deletedCount = 0;

                for (const page of pages) {
                    if (page.name.includes('æµ‹è¯•') || page.name.includes('å¹¶å‘') || page.name.includes('æ‰¹é‡')) {
                        try {
                            await invoke('delete_page', { id: page.id });
                            deletedCount++;
                        } catch (error) {
                            log(`åˆ é™¤é¡µé¢ ${page.id} å¤±è´¥: ${error.toString()}`);
                        }
                    }
                }

                showResult('batch-result', {
                    message: 'æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ',
                    deletedPages: deletedCount,
                    timestamp: new Date().toISOString()
                });

                await updateStats();
                log(`æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${deletedCount} ä¸ªé¡µé¢`);
            } catch (error) {
                showError('batch-result', error);
            }
        };

        window.runFullTestSuite = async function() {
            const startTime = Date.now();
            log('å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶');

            try {
                let results = [];

                // 1. åˆå§‹åŒ–æµ‹è¯•
                results.push('1. æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•...');
                await testInitDatabase();
                results.push('   âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');

                // 2. é¡µé¢CRUDæµ‹è¯•
                results.push('2. é¡µé¢CRUDæµ‹è¯•...');
                await testCreatePage();
                results.push('   âœ… é¡µé¢åˆ›å»ºæˆåŠŸ');
                await testUpdatePage();
                results.push('   âœ… é¡µé¢æ›´æ–°æˆåŠŸ');

                // 3. å—CRUDæµ‹è¯•
                results.push('3. å—CRUDæµ‹è¯•...');
                await testCreateBlock();
                results.push('   âœ… å—åˆ›å»ºæˆåŠŸ');
                await testUpdateBlock();
                results.push('   âœ… å—æ›´æ–°æˆåŠŸ');

                // 4. æœç´¢æµ‹è¯•
                results.push('4. æœç´¢åŠŸèƒ½æµ‹è¯•...');
                await testSearch();
                results.push('   âœ… æœç´¢åŠŸèƒ½æ­£å¸¸');

                // 5. æ•°æ®å®Œæ•´æ€§æµ‹è¯•
                results.push('5. æ•°æ®å®Œæ•´æ€§æµ‹è¯•...');
                await testDataIntegrity();
                results.push('   âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ');

                // 6. æ‰¹é‡æ“ä½œæµ‹è¯•
                results.push('6. æ‰¹é‡æ“ä½œæµ‹è¯•...');
                await testBatchOperations();
                results.push('   âœ… æ‰¹é‡æ“ä½œæˆåŠŸ');

                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;

                results.push('');
                results.push(`ğŸ‰ å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼`);
                results.push(`â±ï¸  æ€»è€—æ—¶: ${duration.toFixed(2)} ç§’`);
                results.push(`ğŸ“Š æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`);

                showResult('full-test-result', {
                    status: 'æµ‹è¯•å¥—ä»¶æ‰§è¡ŒæˆåŠŸ',
                    duration: `${duration.toFixed(2)} ç§’`,
                    results: results,
                    timestamp: new Date().toISOString()
                });

                log(`å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶ ${duration.toFixed(2)} ç§’`);

            } catch (error) {
                showError('full-test-result', error);
                log('æµ‹è¯•å¥—ä»¶æ‰§è¡Œå¤±è´¥: ' + error.toString());
            }
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥
        checkConnection();
    </script>
</body>
</html>
